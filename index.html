<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agreement Manager - Cloud Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Form Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* Main App Styles */
        .main-app {
            display: none;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        .form-field label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow-x: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: block;
            white-space: nowrap;
        }

        .data-table thead,
        .data-table tbody,
        .data-table tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .data-table thead {
            width: calc(100% - 1em);
        }

        .data-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            width: auto;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            width: auto;
        }

        .data-table tbody {
            height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }
		
		.data-table tr:hover {
			background: #f8f9fa;
		}

		admin-only {
			display: none !important;
		}

		.user-only {
			display: none !important;
		}

		.agent-only {
			display: none !important;
		}
	/* === ADD THIS CODE RIGHT HERE === */
	/* Role-based visibility */
	.admin-only {
		display: none !important;
	}

	.user-only {
		display: none !important;
	}

	.agent-only {
		display: none !important;
	}
	/* === END OF ADDED CODE === */

	/* Specific column widths for better display */
	.data-table th:nth-child(1), .data-table td:nth-child(1) { width: 15%; }

        /* Specific column widths for better display */
        .data-table th:nth-child(1), .data-table td:nth-child(1) { width: 15%; }
        .data-table th:nth-child(2), .data-table td:nth-child(2) { width: 12%; }
        .data-table th:nth-child(3), .data-table td:nth-child(3) { width: 15%; }
        .data-table th:nth-child(4), .data-table td:nth-child(4) { width: 12%; }
        .data-table th:nth-child(5), .data-table td:nth-child(5) { width: 12%; }
        .data-table th:nth-child(6), .data-table td:nth-child(6) { width: 10%; }
        .data-table th:nth-child(7), .data-table td:nth-child(7) { width: 12%; }
        .data-table th:nth-child(8), .data-table td:nth-child(8) { width: 12%; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #2ecc71; }
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
			
			.status-indicator {
				margin: 10px 0;
				padding: 10px;
				border-radius: 5px;
				font-weight: 600;
				text-align: center;
			}

			.status-success { 
				background: #d4edda; 
				color: #155724; 
				border: 1px solid #c3e6cb; 
			}

			.status-error { 
				background: #f8d7da; 
				color: #721c24; 
				border: 1px solid #f5c6cb; 
			}

			.status-warning { 
				background: #fff3cd; 
				color: #856404; 
				border: 1px solid #ffeaa7; 
			}

    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1>Agreement Manager</h1>
            <div class="debug-info">
                <strong>Test Credentials:</strong><br>
                Username: admin<br>
                Password: admin123
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
			<div class="form-group">
				<label for="username">Username</label>
				<input type="text" id="username" name="username" placeholder="Enter username" autocomplete="username" required>
			</div>
			<div class="form-group">
				<label for="password">Password</label>
				<input type="password" id="password" name="password" placeholder="Enter password" autocomplete="current-password" required>
			</div>
			<button type="submit" class="login-btn">Login</button>
		</form>
    </div>

	<div id="connectionStatus" class="status-indicator" style="margin: 10px 0; padding: 10px; border-radius: 5px; text-align: center; display: none;">
		<span id="statusText">Checking connection...</span>
	</div


    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <div class="container">
            <div class="header">
                <h1>Agreement Manager - Cloud Edition</h1>
                <div class="user-info">
                    <span>Welcome, <span id="currentUser">User</span></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

			<div class="tabs">
				<button class="tab active" onclick="showTab('agreements', this)">Agreements</button>
				<button class="tab admin-only" onclick="showTab('reports', this)">Reports</button>
				<button class="tab" onclick="showTab('whatsapp', this)">WhatsApp</button>
				<button class="tab" onclick="showTab('logs', this)">Activity Logs</button>
				<button class="tab admin-only" onclick="showTab('settings', this)">Settings</button>
			</div>

            <!-- Agreements Tab -->
            <div class="tab-content active" id="agreements">
                <h2>Agreement Management</h2>
                
                <div class="form-grid">
                    <div class="form-field">
                        <label for="ownerName">Name of Owner</label>
                        <input type="text" id="ownerName" placeholder="Enter owner name">
                    </div>
                    <div class="form-field">
                        <label for="location">Location</label>
                        <input type="text" id="location" placeholder="Enter property location">
                    </div>
                    <div class="form-field">
                        <label for="tokenNumber">Token Number</label>
                        <input type="text" id="tokenNumber" placeholder="Enter token number">
                    </div>
                    <div class="form-field">
                        <label for="agreementDate">Agreement Date</label>
                        <input type="date" id="agreementDate">
                    </div>
                    <div class="form-field">
                        <label for="ownerContact">Owner Contact</label>
                        <input type="tel" id="ownerContact" placeholder="Enter owner contact number">
                    </div>
                    <div class="form-field">
                        <label for="tenantContact">Tenant Contact</label>
                        <input type="tel" id="tenantContact" placeholder="Enter tenant contact number">
                    </div>
                    <div class="form-field">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="Enter email address">
                    </div>
                    <div class="form-field">
                        <label for="expiryDate">Expiry Date</label>
                        <input type="date" id="expiryDate">
                    </div>
                    <div class="form-field">
                        <label for="reminderDate">Reminder Date</label>
                        <input type="date" id="reminderDate">
                    </div>
                    <div class="form-field">
                        <label for="ccEmail">CC Email</label>
                        <input type="email" id="ccEmail" value="support@ramnathshetty.com" readonly>
                    </div>
                    <div class="form-field">
                        <label for="agentName">Agent Name</label>
                        <select id="agentName" title="Select agent name">
                            <option value="">Select Agent</option>
                            <option value="Ramnath">Ramnath</option>
                            <option value="Agent 1">Agent 1</option>
                            <option value="Agent 2">Agent 2</option>
                            <option value="Agent 3">Agent 3</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="totalPayment">Total Payment</label>
                        <input type="number" id="totalPayment" step="0.01" placeholder="Enter total payment amount" onchange="calculateDue()">
                    </div>
                    <div class="form-field">
                        <label for="paymentOwner">Pymnt Rcvd from Owner</label>
                        <input type="number" id="paymentOwner" step="0.01" placeholder="Enter payment from owner" onchange="calculateDue()">
                    </div>
                    <div class="form-field">
                        <label for="paymentTenant">Pymnt Rcvd from Tenant</label>
                        <input type="number" id="paymentTenant" step="0.01" placeholder="Enter payment from tenant" onchange="calculateDue()">
                    </div>
                    <div class="form-field">
                        <label for="paymentReceivedDate1">Pymt Rcvd Dt1</label>
                        <input type="date" id="paymentReceivedDate1">
                    </div>
                    <div class="form-field">
                        <label for="paymentReceivedDate2">Pymt Rcvd Dt2</label>
                        <input type="date" id="paymentReceivedDate2">
                    </div>
                    <div class="form-field">
                        <label for="paymentDue">Payment Due (Auto-calculated)</label>
                        <input type="number" id="paymentDue" step="0.01" readonly placeholder="Auto-calculated">
                    </div>
                    <div class="form-field">
                        <label for="agreementStatus">Agreement Status</label>
                        <select id="agreementStatus" title="Select agreement status">
                            <option value="Drafted">Drafted</option>
                            <option value="Sent to Client">Sent to Client</option>
                            <option value="Biometric Scheduled">Biometric Scheduled</option>
                            <option value="Biometrics Completed">Biometrics Completed</option>
                            <option value="Send Final Draft to Client">Send Final Draft to Client</option>
                            <option value="Submitted">Submitted</option>
                            <option value="Registered">Registered</option>
                            <option value="Registered agreement sent to the client">Registered agreement sent to the client</option>
                        </select>
                    </div>
									
				<div class="form-field">
                        <label for="biometricDate">Biometric Scheduled Date</label>
                        <input type="date" id="biometricDate">
                    </div>

                    <div class="form-field">
                        <label for="actualCost">Actual Cost/Expenses</label>
                        <input type="number" id="actualCost" step="0.01" placeholder="Enter actual expenses" onchange="calculateProfit()">
                    </div>

                    <div class="form-field">
                        <label for="agentCommission">Agent Commission</label>
                        <input type="number" id="agentCommission" step="0.01" placeholder="Enter agent commission" onchange="calculateProfit()">
                    </div>

                    <div class="form-field">
                        <label for="otherExpenses">Other Expenses</label>
                        <input type="number" id="otherExpenses" step="0.01" placeholder="Enter other expenses" onchange="calculateProfit()">
                    </div>

                    <div class="form-field">
                        <label for="grossProfit">Gross Profit (Auto-calculated)</label>
                        <input type="number" id="grossProfit" step="0.01" readonly placeholder="Gross profit will appear here">
                    </div>

                    <div class="form-field">
                        <label for="netProfit">Net Profit (Auto-calculated)</label>
                        <input type="number" id="netProfit" step="0.01" readonly placeholder="Net profit will appear here">
                    </div>

                    <div class="form-field">
                        <label for="profitMargin">Profit Margin % (Auto-calculated)</label>
                        <input type="number" id="profitMargin" step="0.01" readonly placeholder="Profit margin will appear here">
                    </div>

                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveAgreement()">Add Agreement</button>
                    <button class="btn btn-success" onclick="exportData()">Export All Data (CSV)</button>
                    <button class="btn btn-warning" onclick="showNotification('Test notification works!', 'warning')">Test Notification</button>
                </div>

                <div style="overflow-x: auto; margin-bottom: 20px;">
                    <table class="data-table" id="agreementsTable" style="min-width: 1200px;">
                        <thead>
                            <tr>
                                <th style="width: 150px;">Name of Owner</th>
                                <th style="width: 120px;">Location</th>
                                <th style="width: 100px;">Token Number</th>
                                <th style="width: 120px;">Owner Contact</th>
                                <th style="width: 120px;">Tenant Contact</th>
                                <th style="width: 100px;">Agent</th>
                                <th style="width: 120px;">Total Payment</th>
                                <th style="width: 120px;">Payment Due</th>
                                <th style="width: 120px;">Status</th>
                                <th style="width: 100px;">Expiry Date</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
			
			<!-- Add these to your form-grid in the Agreements tab -->

		
            <!-- Reports Tab -->
            <div class="tab-content" id="reports">
                <h2>Reports & Analytics</h2>
                <p style="margin-bottom: 20px; font-weight: 600; color: #2c3e50;">Select a filter to generate a report:</p>
                
                <!-- Filter by Agent -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #3498db;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Filter by Agent</h4>
                    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                        <div class="form-field" style="min-width: 200px;">
                            <label for="reportAgentName">Agent Name:</label>
                            <select id="reportAgentName">
                                <option value="">Select Agent</option>
                                <option value="Ramnath">Ramnath</option>
                                <option value="Agent 1">Agent 1</option>
                                <option value="Agent 2">Agent 2</option>
                                <option value="Agent 3">Agent 3</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="generateReportByAgent()">Generate Report by Agent</button>
                        <button class="btn btn-warning" onclick="clearAgentFilter()">Clear</button>
                    </div>
                </div>
				
				<!-- Profit Reports Section -->
				<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
					<h4 style="color: #2c3e50; margin-bottom: 15px;">💰 Profit Analysis Reports</h4>
					<div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
						<div class="form-field">
							<label for="profitFromDate">From Date:</label>
							<input type="date" id="profitFromDate">
						</div>
						<div class="form-field">
							<label for="profitToDate">To Date:</label>
							<input type="date" id="profitToDate">
						</div>
						<div class="form-field">
							<label for="profitAgentFilter">Filter by Agent:</label>
							<select id="profitAgentFilter">
								<option value="">All Agents</option>
								<option value="Ramnath">Ramnath</option>
								<option value="Agent 1">Agent 1</option>
								<option value="Agent 2">Agent 2</option>
							</select>
						</div>
						<button class="btn btn-success" onclick="generateProfitReport()">Generate Profit Report</button>
						<button class="btn btn-warning" onclick="clearProfitFilter()">Clear</button>
					</div>
				</div>

				<!-- Profit Summary Cards -->
				<div id="profitSummary" style="display: none; margin-bottom: 20px;">
					<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
						<div style="background: #2ecc71; color: white; padding: 20px; border-radius: 10px; text-align: center;">
							<h4>Total Revenue</h4>
							<h3 id="totalRevenue">₹0.00</h3>
						</div>
						<div style="background: #3498db; color: white; padding: 20px; border-radius: 10px; text-align: center;">
							<h4>Total Profit</h4>
							<h3 id="totalProfit">₹0.00</h3>
						</div>
						<div style="background: #9b59b6; color: white; padding: 20px; border-radius: 10px; text-align: center;">
							<h4>Average Margin</h4>
							<h3 id="averageMargin">0%</h3>
						</div>
						<div style="background: #e74c3c; color: white; padding: 20px; border-radius: 10px; text-align: center;">
							<h4>Most Profitable Agent</h4>
							<h3 id="topAgent">-</h3>
						</div>
					</div>
				</div>

                <!-- Expiring Agreements -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #e74c3c;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Expiring Agreements</h4>
                    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                        <div class="form-field">
                            <label for="expiryFromDate">From:</label>
                            <input type="date" id="expiryFromDate">
                        </div>
                        <div class="form-field">
                            <label for="expiryToDate">To:</label>
                            <input type="date" id="expiryToDate">
                        </div>
                        <button class="btn btn-danger" onclick="generateExpiringReport()">Generate Expiring Agreements Report</button>
                        <button class="btn btn-warning" onclick="clearExpiryFilter()">Clear</button>
                    </div>
                </div>

                <!-- Filter by Pending Amount -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #f39c12;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Filter by Pending Amount</h4>
                    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                        <div class="form-field" style="min-width: 200px;">
                            <label for="pendingAmountFilter">Pending Amount:</label>
                            <select id="pendingAmountFilter">
                                <option value="">Select Condition</option>
                                <option value="greater">Greater than zero</option>
                                <option value="less">Less than zero</option>
                            </select>
                        </div>
                        <button class="btn btn-warning" onclick="generatePendingReport()">Generate Pending Report</button>
                        <button class="btn btn-warning" onclick="clearPendingFilter()">Clear</button>
                    </div>
                </div>

                <!-- Export Button -->
                <div style="margin-bottom: 25px;">
                    <button class="btn btn-success" onclick="exportReport()">Export Report to Excel</button>
                </div>

                <!-- Report Results Table -->
                <div style="overflow-x: auto;">
                    <table class="data-table" id="reportTable" style="display: none; min-width: 800px;">
                        <thead>
                            <tr style="background: #e74c3c;">
                                <th style="width: 150px;">Name of Owner</th>
                                <th style="width: 120px;">Token Number</th>
                                <th style="width: 150px;">Location</th>
                                <th style="width: 130px;">Total Amount Charged</th>
                                <th style="width: 120px;">Payment Due</th>
                                <th style="width: 120px;">Agent Name</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- No Results Message -->
                <div id="noResults" style="display: none; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; color: #666;">
                    <p>No records found matching the selected criteria.</p>
                    <p>Try adjusting your filter options and generate the report again.</p>
                </div>
            </div>

            <!-- WhatsApp Tab -->
            <div class="tab-content" id="whatsapp">
                <h2>WhatsApp Notifications</h2>
                <p>WhatsApp integration will be available here.</p>
            </div>

            <!-- Activity Logs Tab -->
            <div class="tab-content" id="logs">
                <h2>Activity Logs</h2>
                <div id="logsContainer">
                    <p>Activity logs will appear here after you perform actions.</p>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <h2>System Settings & Administration</h2>
                
          
                <!-- User Management Section -->
				<div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #3498db;">
					<h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
						<span style="margin-right: 10px;">👥</span> User Management
					</h3>
					
					<!-- Add User Form -->
						<form onsubmit="addNewUser(event)">
							<div class="form-grid" style="margin-bottom: 20px;">
								<div class="form-field">
									<label for="newUsername">New Username</label>
									<input type="text" id="newUsername" placeholder="Enter username" required>
								</div>
								<div class="form-field">
									<label for="newUserPassword">Password</label>
									<input type="password" id="newUserPassword" placeholder="Enter password" required autocomplete="new-password">
								</div>
								<div class="form-field">
									<label for="newUserRole">User Role</label>
									<select id="newUserRole" required>
										<option value="user">User</option>
										<option value="admin">Administrator</option>
										<option value="agent">Agent</option>
										<option value="manager">Manager</option>
									</select>
								</div>
							</div>

							<div class="btn-group">
								<button type="submit" class="btn btn-success">Add User</button>
								<button type="button" class="btn btn-warning" onclick="retryConnection()" style="margin-top: 10px; width: 100%;">
									Retry Connection
								</button>
							</div>
						</form>

						<!-- Change Password Form -->
						<form onsubmit="changePassword(event)" style="margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
							<h4>Change Password</h4>
							<div style="margin-bottom: 15px;">
								<label for="currentPassword">Current Password:</label>
								<input type="password" id="currentPassword" autocomplete="current-password" required>
							</div>
							<div style="margin-bottom: 15px;">
								<label for="newPassword">New Password:</label>
								<input type="password" id="newPassword" autocomplete="new-password" required>
							</div>
							<div style="margin-bottom: 15px;">
								<label for="confirmPassword">Confirm New Password:</label>
								<input type="password" id="confirmPassword" autocomplete="new-password" required>
							</div>
							<button type="submit" class="btn btn-warning">Change Password</button>
						</form>

					
					<!-- User List Table -->
					<div id="userListContainer" style="margin-top: 20px; display: none;">
						<h4>Current Users:</h4>
						<table class="data-table" id="usersTable" style="margin-top: 10px;">
							<thead>
								<tr>
									<th>Username</th>
									<th>Role</th>
									<th>Created Date</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>

                <!-- Backup & Restore Section -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #e74c3c;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">💾</span> Backup & Restore
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Backup Section -->
                        <div>
                            <h4 style="margin-bottom: 15px;">Create Backup</h4>
                            <p style="margin-bottom: 15px; color: #666;">Download a complete backup of all your data including agreements, users, and settings.</p>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="createBackup()">Create Full Backup</button>
                            </div>
                        </div>
                        
                        <!-- Restore Section -->
                        <div>
                            <h4 style="margin-bottom: 15px;">Restore from Backup</h4>
                            <p style="margin-bottom: 15px; color: #666;">Import data from a previously created backup file.</p>
                            <input type="file" id="backupFileInput" accept=".json,.csv" style="margin-bottom: 15px;">
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="restoreFromBackup()">Restore Data</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Configuration -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #27ae60;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">⚙️</span> System Configuration
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="defaultCCEmail">Default CC Email</label>
                            <input type="email" id="defaultCCEmail" value="support@ramnathshetty.com">
                        </div>
                        <div class="form-field">
                            <label for="companyName">Company Name</label>
                            <input type="text" id="companyName" value="Shetty Legal Advisors">
                        </div>
                        <div class="form-field">
                            <label for="reminderDaysBefore">Reminder Days Before Expiry</label>
                            <input type="number" id="reminderDaysBefore" value="30" min="1" max="365">
                        </div>
                        <div class="form-field">
                            <label for="dateFormat">Date Format</label>
                            <select id="dateFormat">
                                <option value="DD-MM-YYYY">DD-MM-YYYY (Indian)</option>
                                <option value="MM-DD-YYYY">MM-DD-YYYY (US)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="currencySymbol">Currency Symbol</label>
                            <select id="currencySymbol">
                                <option value="₹">₹ (Indian Rupee)</option>
                                <option value="$">$ (US Dollar)</option>
                                <option value="€">€ (Euro)</option>
                                <option value="£">£ (British Pound)</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="maxRecordsPerPage">Records Per Page</label>
                            <select id="maxRecordsPerPage">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveSystemSettings()">Save Settings</button>
                    </div>
                </div>

                <!-- Security & Maintenance -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #f39c12;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">🔒</span> Security & Maintenance
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Security Settings -->
                        <div>
                            <h4 style="margin-bottom: 15px;">Security Settings</h4>
                            <div style="margin-bottom: 15px;">
                                <label for="sessionTimeout">Session Timeout (minutes)</label>
                                <input type="number" id="sessionTimeout" value="60" min="5" max="480">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label>
                                    <input type="checkbox" id="forcePasswordChange"> Force password change on first login
                                </label>
                            </div>
                            <button class="btn btn-warning" onclick="changePassword()">Change My Password</button>
                        </div>
                        
                        <!-- Maintenance -->
                        <div>
                            <h4 style="margin-bottom: 15px;">System Maintenance</h4>
                            <div style="margin-bottom: 15px;">
                                <p style="color: #666; font-size: 14px;">Total Agreements: <span id="totalAgreements">0</span></p>
                                <p style="color: #666; font-size: 14px;">Total Users: <span id="totalUsers">0</span></p>
                                <p style="color: #666; font-size: 14px;">Database Size: <span id="databaseSize">~2MB</span></p>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="refreshData()">Refresh Data</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; border-left: 4px solid #9b59b6;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">ℹ️</span> System Information
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4 style="margin-bottom: 15px;">Application Details</h4>
                            <p><strong>Version:</strong> 1.0.0</p>
                            <p><strong>Build Date:</strong> <span id="buildDate">2024-09-24</span></p>
                            <p><strong>Current User:</strong> <span id="currentUserInfo">admin</span></p>
                            <p><strong>Login Time:</strong> <span id="loginTime">-</span></p>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px;">License & Support</h4>
                            <p><strong>Licensed to:</strong> Shetty Legal Advisors</p>
                            <p><strong>Support Email:</strong> support@ramnathshetty.com</p>
                            <p><strong>Last Backup:</strong> <span id="lastBackupTime">Never</span></p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="checkForUpdates()">Check for Updates</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Agreement</h2>
            <div class="form-grid" id="editFormGrid">
				<input type="hidden" id="editAgreementId">		
                <!-- Edit form fields will be populated here -->
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveEditedAgreement()">Save Changes</button>
                <button class="btn btn-danger" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
    // Cloud-based API functions
    const API_BASE_URL = '/api';

    // Authentication functions
		async function handleLogin(event) {
		if (event) event.preventDefault();
		
		const username = document.getElementById('username').value;
		const password = document.getElementById('password').value;

		if (!username || !password) {
			showNotification('Please enter both username and password', 'error');
			return;
		}

		try {
			console.log('Attempting login for user:', username);
			
			const response = await fetch('/api/auth/login', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ username, password })
			});

			// Check if response is OK first
			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || `Login failed with status: ${response.status}`);
			}

			const responseData = await response.json();
			console.log('Login response:', responseData);

			// Handle different response structures
			let authToken, userRole;
			
			if (responseData.token) {
				// Structure 1: { token: "abc", user: { role: "admin" } }
				authToken = responseData.token;
				userRole = responseData.user?.role || 'user';
			} else if (responseData.accessToken) {
				// Structure 2: { accessToken: "abc", role: "admin" }
				authToken = responseData.accessToken;
				userRole = responseData.role || 'user';
			} else if (responseData.user && responseData.user.token) {
				// Structure 3: { user: { token: "abc", role: "admin" } }
				authToken = responseData.user.token;
				userRole = responseData.user.role || 'user';
			} else {
				throw new Error('Invalid response structure from server');
			}

			if (!authToken) {
				throw new Error('No authentication token received');
			}

			// Store authentication data
			localStorage.setItem('authToken', authToken);
			localStorage.setItem('currentUser', username);
			localStorage.setItem('userRole', userRole);
			
			showNotification('Login successful!', 'success');
			setTimeout(() => {
				debugApiResponse('/agreements');
				debugApiResponse('/settings');
			}, 1000);
			// In your handleLogin function, replace the success handling:
		if (response.ok) {
			const responseData = await response.json();
			console.log('Full login response:', responseData);
			
			// Extract token and role from different possible structures
			let authToken, userRole, userName;
			
			// Structure 1: { token: "abc", user: { role: "admin", username: "admin" } }
			if (responseData.token) {
				authToken = responseData.token;
				userRole = responseData.user?.role || 'user';
				userName = responseData.user?.username || username;
			}
			// Structure 2: { accessToken: "abc", role: "admin", username: "admin" }
			else if (responseData.accessToken) {
				authToken = responseData.accessToken;
				userRole = responseData.role || 'user';
				userName = responseData.username || username;
			}
			// Structure 3: { user: { token: "abc", role: "admin", username: "admin" } }
			else if (responseData.user && responseData.user.token) {
				authToken = responseData.user.token;
				userRole = responseData.user.role || 'user';
				userName = responseData.user.username || username;
			}
			// Structure 4: Direct properties
			else if (responseData.role) {
				authToken = responseData.token || responseData.accessToken;
				userRole = responseData.role;
				userName = responseData.username || username;
			}
			else {
				console.warn('Unexpected login response structure:', responseData);
				// Default fallback
				authToken = responseData.token || responseData.accessToken;
				userRole = 'user';
				userName = username;
			}
			
			if (!authToken) {
				throw new Error('No authentication token received from server');
			}
			
			// Store authentication data
			localStorage.setItem('authToken', authToken);
			localStorage.setItem('currentUser', userName);
			localStorage.setItem('userRole', userRole);
			
			console.log('Stored auth - User:', userName, 'Role:', userRole);
			
			showNotification('Login successful!', 'success');
			
			// Update UI
			document.getElementById('loginContainer').style.display = 'none';
			document.getElementById('mainApp').style.display = 'block';
			updateUIVisibility();
			
			document.getElementById('currentUser').textContent = userName;
			document.getElementById('currentUserInfo').textContent = userName;
			document.getElementById('loginTime').textContent = new Date().toLocaleString();
			
			// Load initial data
			await loadAgreements();
			await loadSystemSettings();
		}
					
			// Update UI
			document.getElementById('loginContainer').style.display = 'none';
			document.getElementById('mainApp').style.display = 'block';
			updateUIVisibility();
			
			document.getElementById('currentUser').textContent = username;
			document.getElementById('currentUserInfo').textContent = username;
			document.getElementById('loginTime').textContent = new Date().toLocaleString();
			
			// Load initial data
			await loadAgreements();
			await loadSystemSettings();
			
		} catch (error) {
			console.error('Login error:', error);
			showNotification(error.message || 'Login failed. Please check credentials.', 'error');
		}
	}
	
    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userRole');
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        showNotification('Logged out successfully', 'success');
    }

    // Check authentication on page load
    // Check authentication on page load
		function checkAuth() {
			const token = localStorage.getItem('authToken');
			const user = localStorage.getItem('currentUser');
			
			if (token && user) {
				document.getElementById('loginContainer').style.display = 'none';
				document.getElementById('mainApp').style.display = 'block';

				// --- ADD THIS LINE ---
				// This makes sure the correct tabs are shown for returning users.
				updateUIVisibility(); 

				document.getElementById('currentUser').textContent = user;
				document.getElementById('currentUserInfo').textContent = user;
				document.getElementById('loginTime').textContent = new Date().toLocaleString();
				loadAgreements();
				loadSystemSettings();
			}
		}
	
	// PASTE THIS ENTIRE FUNCTION INTO YOUR SCRIPT TAG

	function updateUIVisibility() {
			const userRole = localStorage.getItem('userRole') || 'user';
			console.log(`Updating UI for role: ${userRole}`);
			
			// Show/hide admin-only elements
			document.querySelectorAll('.admin-only').forEach(el => {
				if (userRole === 'admin') {
					el.style.display = 'block';
				} else {
					el.style.display = 'none';
				}
			});
			
			// Show/hide user-only elements
			document.querySelectorAll('.user-only').forEach(el => {
				if (userRole === 'user') {
					el.style.display = 'block';
				} else {
					el.style.display = 'none';
				}
			});
			
			// Show/hide agent-only elements
			document.querySelectorAll('.agent-only').forEach(el => {
				if (userRole === 'agent') {
					el.style.display = 'block';
				} else {
					el.style.display = 'none';
				}
			});
			
			// Ensure at least one tab is active
			const activeTabs = document.querySelectorAll('.tab.active');
			if (activeTabs.length === 0) {
				// Activate the first visible tab
				const firstVisibleTab = document.querySelector('.tab:not([style*="display: none"])');
				if (firstVisibleTab) {
					firstVisibleTab.click();
				} else {
					// Fallback: show agreements tab
					showTab('agreements', document.querySelector('.tab'));
				}
			}
		}
	
	// Calculate profit fields on the form
		function calculateProfit() {
			const total = parseFloat(document.getElementById('totalPayment').value) || 0;
			const cost = parseFloat(document.getElementById('actualCost').value) || 0;
			const commission = parseFloat(document.getElementById('agentCommission').value) || 0;
			const other = parseFloat(document.getElementById('otherExpenses').value) || 0;

			const grossProfit = total - cost;
			const netProfit = grossProfit - commission - other;
			const profitMargin = total > 0 ? (netProfit / total) * 100 : 0;

			document.getElementById('grossProfit').value = grossProfit.toFixed(2);
			document.getElementById('netProfit').value = netProfit.toFixed(2);
			document.getElementById('profitMargin').value = profitMargin.toFixed(2);
		}
		
		async function retryConnection() {
			const success = await testConnection();
			if (success) {
				showNotification('Connection restored!', 'success');
			}
}

		async function apiCall(endpoint, options = {}) {
			const token = localStorage.getItem('authToken');
			const headers = {
				'Content-Type': 'application/json',
				...options.headers
			};

			if (token) {
				headers['Authorization'] = `Bearer ${token}`;
			}

			try {
				const fullUrl = `/api${endpoint}`;
				console.log('API Call:', fullUrl, options.method || 'GET');

				const response = await fetch(fullUrl, {
					...options,
					headers
				});

				console.log('Response status:', response.status);
				console.log('Response ok:', response.ok);

				if (response.status === 401) {
					showNotification('Session expired. Please login again.', 'error');
					logout();
					throw new Error('Authentication required');
				}

				// Get the response text first to see what we're dealing with
				const responseText = await response.text();
				console.log('Raw response text:', responseText);

				if (!response.ok) {
					let errorMessage = `Request failed with status ${response.status}`;
					
					try {
						const errorData = JSON.parse(responseText);
						errorMessage = errorData.error || errorData.message || errorMessage;
					} catch {
						errorMessage = responseText || errorMessage;
					}
					
					throw new Error(errorMessage);
				}

				// If empty response (like 204 No Content)
				if (!responseText) {
					console.log('Empty response, returning null');
					return null;
				}

				// Try to parse as JSON
				try {
					const jsonData = JSON.parse(responseText);
					console.log('Parsed JSON data:', jsonData);
					return jsonData;
				} catch (parseError) {
					console.log('Response is not JSON, returning as text');
					return responseText;
				}

			} catch (error) {
				console.error('API call error:', error);
				
				if (error.name === 'TypeError' && error.message.includes('fetch')) {
					showNotification('Network error. Please check your connection.', 'error');
				} else {
					showNotification(error.message || 'Request failed. Please try again.', 'error');
				}
				
				throw error;
			}
		}
		
	function debugUIVisibility() {
		console.log('=== UI Visibility Debug ===');
		console.log('User Role:', localStorage.getItem('userRole'));
		console.log('Admin-only elements:', document.querySelectorAll('.admin-only').length);
		console.log('Visible admin-only elements:', document.querySelectorAll('.admin-only:not([style*="display: none"])').length);
		console.log('Active tabs:', document.querySelectorAll('.tab.active').length);
		
		document.querySelectorAll('.tab').forEach((tab, index) => {
			console.log(`Tab ${index}:`, tab.textContent, 'visible:', tab.offsetParent !== null);
		});
	}
    
		async function testConnection() {
			const statusElement = document.getElementById('connectionStatus');
			const statusText = document.getElementById('statusText');
			
			if (statusElement) {
				statusElement.style.display = 'block';
				statusElement.className = 'status-indicator status-warning';
				statusText.textContent = 'Checking server connection...';
			}

			try {
				const response = await fetch('/api/auth/status', {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json',
					}
				});

				if (response.ok) {
					if (statusElement) {
						statusElement.className = 'status-indicator status-success';
						statusText.textContent = '✅ Server connection successful';
					}
					return true;
				} else {
					throw new Error(`Server returned status: ${response.status}`);
				}
			} catch (error) {
				console.error('Connection test failed:', error);
				
				if (statusElement) {
					statusElement.className = 'status-indicator status-error';
					statusText.textContent = '❌ Cannot connect to server';
				}
				
				// Try alternative endpoints
				return await tryAlternativeEndpoints();
			}
		}

		async function tryAlternativeEndpoints() {
			const endpoints = [
				'/api/test',
				'/api/health',
				'/auth/status',
				'/test'
			];
			
			for (const endpoint of endpoints) {
				try {
					const response = await fetch(endpoint);
					if (response.ok) {
						console.log(`✅ Connected via alternative endpoint: ${endpoint}`);
						return true;
					}
				} catch (error) {
					console.log(`Endpoint ${endpoint} failed:`, error.message);
				}
			}
			return false;
		}

    // Test on page load
			document.addEventListener('DOMContentLoaded', function() {
			// Test connection first
			testConnection().then(success => {
				if (success) {
					console.log('✅ Backend connection successful');
					// Only check auth if connection is successful
					checkAuth();
				} else {
					console.log('❌ Backend connection failed');
					showNotification('Cannot connect to server. Please check if the backend is running.', 'error');
					// Still check auth in case we have cached credentials
					checkAuth();
				}
			});
		});

    // Tab management
    function showTab(tabName, element) {
		// Hide all tab contents
		document.querySelectorAll('.tab-content').forEach(tab => {
			tab.classList.remove('active');
		});
		
		// Remove active class from all tabs
		document.querySelectorAll('.tab').forEach(tab => {
			tab.classList.remove('active');
		});
		
		// Show selected tab content and set active tab
		const tabContent = document.getElementById(tabName);
		if (tabContent) {
			tabContent.classList.add('active');
			element.classList.add('active');
			
			// Load tab-specific data if needed
			loadTabData(tabName);
		} else {
			console.error(`Tab content not found: ${tabName}`);
			// Fallback to agreements tab
			showTab('agreements', document.querySelector('.tab'));
		}
	}

    // Async function to load tab-specific data
    async function loadTabData(tabName) {
        try {
            switch(tabName) {
                case 'agreements':
                    await loadAgreements();
                    break;
                case 'reports':
                    await loadAgentsForReports();
                    break;
                case 'logs':
                    await loadActivityLogs();
                    break;
                case 'settings':
                    await loadSystemSettings();
                    break;
            }
        } catch (error) {
            console.error(`Error loading ${tabName} data:`, error);
        }
    }

    // Notification function
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }


		async function debugApiResponse(endpoint) {
			try {
				const response = await fetch(`/api${endpoint}`);
				console.log(`=== DEBUG ${endpoint} ===`);
				console.log('Response status:', response.status);
				console.log('Response headers:', Object.fromEntries(response.headers.entries()));
				
				const text = await response.text();
				console.log('Raw response:', text);
				
				try {
					const json = JSON.parse(text);
					console.log('Parsed JSON:', json);
				} catch (e) {
					console.log('Not JSON:', e.message);
				}
			} catch (error) {
				console.error('Debug error:', error);
			}
		}
    // Load agreements function - FIXED
		async function loadAgreements() {
			try {
				console.log('Loading agreements...');
				const response = await apiCall('/agreements');
				console.log('Full API response:', response);
				
				// Handle different response structures
				let agreements = [];
				
				if (Array.isArray(response)) {
					// Case 1: Direct array response
					agreements = response;
				} else if (response && typeof response === 'object') {
					// Case 2: Object with agreements property
					agreements = response.agreements || response.data || response.results || [];
				}
				
				console.log('Final agreements array:', agreements);
				displayAgreements(agreements);
				
			} catch (error) {
				console.error('Error loading agreements:', error);
				showNotification('Error loading agreements', 'error');
				displayAgreements([]);
			}
		}

    // Display agreements function - FIXED
    function displayAgreements(agreements) {
        try {
            const tbody = document.querySelector('#agreementsTable tbody');
            tbody.innerHTML = '';

            if (!agreements || agreements.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 20px; color: #666;">
                            No agreements found. Click "Add Agreement" to create your first agreement.
                        </td>
                    </tr>
                `;
                return;
            }

            agreements.forEach(agreement => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(agreement.owner_name || '-')}</td>
                    <td>${escapeHtml(agreement.location || '-')}</td>
                    <td>${escapeHtml(agreement.token_number || '-')}</td>
                    <td>${escapeHtml(agreement.owner_contact || '-')}</td>
                    <td>${escapeHtml(agreement.tenant_contact || '-')}</td>
                    <td>${escapeHtml(agreement.agent_name || '-')}</td>
                    <td>${formatCurrency(agreement.total_payment || 0)}</td>
                    <td>${formatCurrency(agreement.payment_due || 0)}</td>
                    <td>${escapeHtml(agreement.agreement_status || '-')}</td>
                    <td>${formatDate(agreement.expiry_date)}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editAgreement(${agreement.id})" style="padding: 5px 10px; font-size: 12px;">Edit</button>
                        <button class="btn btn-danger" onclick="deleteAgreement(${agreement.id})" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error displaying agreements:', error);
            showNotification('Error loading agreements data', 'error');
        }
    }

    // Save agreement function - FIXED
    async function saveAgreement() {
		try {
			const agreementData = collectAgreementData();
			
			showNotification('Saving agreement...', 'warning');
			
			const response = await apiCall('/agreements', {
				method: 'POST',
				body: JSON.stringify(agreementData)
			});

			if (response.ok) {
				showNotification('Agreement saved successfully!', 'success');
				clearForm();
				await loadAgreements();
			} else {
				const error = await response.json();
				throw new Error(error.error || 'Failed to save agreement');
			}
		} catch (error) {
			console.error('Save agreement error:', error);
			showNotification(error.message || 'Error saving agreement', 'error');
		}
	}
    // Collect agreement data from form - FIXED
    function collectAgreementData() {
        return {
            ownerName: document.getElementById('ownerName').value,
            location: document.getElementById('location').value,
            tokenNumber: document.getElementById('tokenNumber').value,
            agreementDate: document.getElementById('agreementDate').value,
            ownerContact: document.getElementById('ownerContact').value,
            tenantContact: document.getElementById('tenantContact').value,
            email: document.getElementById('email').value,
            expiryDate: document.getElementById('expiryDate').value,
            reminderDate: document.getElementById('reminderDate').value,
            ccEmail: document.getElementById('ccEmail').value,
            agentName: document.getElementById('agentName').value,
            totalPayment: parseFloat(document.getElementById('totalPayment').value) || 0,
            paymentOwner: parseFloat(document.getElementById('paymentOwner').value) || 0,
            paymentTenant: parseFloat(document.getElementById('paymentTenant').value) || 0,
            paymentReceivedDate1: document.getElementById('paymentReceivedDate1').value,
            paymentReceivedDate2: document.getElementById('paymentReceivedDate2').value,
            paymentDue: parseFloat(document.getElementById('paymentDue').value) || 0,
            agreementStatus: document.getElementById('agreementStatus').value,
            biometricDate: document.getElementById('biometricDate').value
        };
    }

    // Clear form function - FIXED
    function clearForm() {
        document.querySelectorAll('#agreements input, #agreements select').forEach(element => {
            if (element.id !== 'ccEmail' && !element.readOnly) {
                element.value = '';
            }
        });
    }

    // Calculate due amount
    function calculateDue() {
        const total = parseFloat(document.getElementById('totalPayment').value) || 0;
        const owner = parseFloat(document.getElementById('paymentOwner').value) || 0;
        const tenant = parseFloat(document.getElementById('paymentTenant').value) || 0;
        const due = total - owner - tenant;
        document.getElementById('paymentDue').value = due.toFixed(2);
    }

    // Delete agreement function - FIXED
    async function deleteAgreement(id) {
        if (!confirm('Are you sure you want to delete this agreement?')) {
            return;
        }

        try {
            const response = await apiCall(`/agreements/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('Agreement deleted successfully!', 'success');
                await loadAgreements();
            } else {
                throw new Error('Failed to delete agreement');
            }
        } catch (error) {
            showNotification('Error deleting agreement', 'error');
        }
    }

    // A global variable to hold the list of all form fields
	const agreementFormFields = [
		'ownerName', 'location', 'tokenNumber', 'agreementDate', 'ownerContact', 
		'tenantContact', 'email', 'expiryDate', 'reminderDate', 'ccEmail', 
		'agentName', 'totalPayment', 'paymentOwner', 'paymentTenant', 
		'paymentReceivedDate1', 'paymentReceivedDate2', 'paymentDue', 'agreementStatus', 
		'biometricDate', 'actualCost', 'agentCommission', 'otherExpenses', 
		'grossProfit', 'netProfit', 'profitMargin'
	];

	async function editAgreement(id) {
		try {
			const response = await apiCall(`/agreements/${id}`);
			if (!response.ok) {
				throw new Error('Failed to fetch agreement details.');
			}
			const agreement = await response.json();

			// Populate the form fields dynamically
			const formGrid = document.getElementById('editFormGrid');
			const mainForm = document.querySelector('.tab-content.active .form-grid');
			
			// Clone the main form's structure into the modal
			formGrid.innerHTML = mainForm.innerHTML;
			document.getElementById('editAgreementId').value = id; // Set the hidden ID

			// Map database keys to form field IDs and populate
			const keyMap = {
				owner_name: 'ownerName', location: 'location', token_number: 'tokenNumber',
				agreement_date: 'agreementDate', owner_contact: 'ownerContact', tenant_contact: 'tenantContact',
				email: 'email', expiry_date: 'expiryDate', reminder_date: 'reminderDate',
				cc_email: 'ccEmail', agent_name: 'agentName', total_payment: 'totalPayment',
				payment_owner: 'paymentOwner', payment_tenant: 'paymentTenant', payment_due: 'paymentDue',
				agreement_status: 'agreementStatus', biometric_date: 'biometricDate', actual_cost: 'actualCost',
				agent_commission: 'agentCommission', other_expenses: 'otherExpenses', gross_profit: 'grossProfit',
				net_profit: 'netProfit', profit_margin: 'profitMargin'
				// NOTE: paymentReceivedDate1/2 are not in the DB schema, handle as needed
			};

			for (const key in keyMap) {
				const fieldId = keyMap[key];
				const element = formGrid.querySelector(`#${fieldId}`);
				if (element) {
					// Format date fields correctly for input type="date"
					if (['agreement_date', 'expiry_date', 'reminder_date', 'biometric_date'].includes(key) && agreement[key]) {
						element.value = new Date(agreement[key]).toISOString().split('T')[0];
					} else {
						element.value = agreement[key] || '';
					}
				}
			}

			// Show the modal
			document.getElementById('editModal').style.display = 'block';
			
		} catch (error) {
			console.error('Edit error:', error);
			showNotification(error.message, 'error');
		}
	}
	
	// --- Settings Management Function ---

	async function saveSystemSettings() {
		// 1. Collect all the values from the settings form
		const settingsData = {
			defaultCCEmail: document.getElementById('defaultCCEmail').value,
			companyName: document.getElementById('companyName').value,
			reminderDaysBefore: document.getElementById('reminderDaysBefore').value,
			dateFormat: document.getElementById('dateFormat').value,
			currencySymbol: document.getElementById('currencySymbol').value,
			maxRecordsPerPage: document.getElementById('maxRecordsPerPage').value,
			sessionTimeout: document.getElementById('sessionTimeout').value
		};

		try {
			// 2. Send the data to the backend endpoint
			const response = await apiCall('/settings', {
				method: 'PUT',
				body: JSON.stringify(settingsData)
			});

			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || 'Failed to save settings.');
			}
			
			// 3. Show success and update UI if needed
			showNotification('System settings saved successfully!', 'success');
			
			// Optional: Update the CC email field on the Agreements tab to reflect the change
			document.getElementById('ccEmail').value = settingsData.defaultCCEmail;

		} catch (error) {
			console.error('Save settings error:', error);
			showNotification(error.message, 'error');
		}
	}
	
	
	// --- User Management Functions ---

	// Add a new user
	async function addNewUser(event) {
		event.preventDefault();
		const username = document.getElementById('newUsername').value;
		const password = document.getElementById('newUserPassword').value;
		const role = document.getElementById('newUserRole').value;

		try {
			const response = await apiCall('/users', {
				method: 'POST',
				body: JSON.stringify({ username, password, role })
			});
			const data = await response.json();

			if (!response.ok) {
				throw new Error(data.error || 'Failed to add user.');
			}

			showNotification(`User "${data.username}" created successfully!`, 'success');
			document.getElementById('newUsername').value = '';
			document.getElementById('newUserPassword').value = '';
			await showUserList(); // Refresh the user list
		} catch (error) {
			showNotification(error.message, 'error');
		}
	}

	// Fetch and display the list of users
	async function showUserList() {
		const container = document.getElementById('userListContainer');
		const tbody = document.getElementById('usersTable').querySelector('tbody');
		tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
		container.style.display = 'block';

		try {
			const response = await apiCall('/users');
			const users = await response.json();
			tbody.innerHTML = ''; // Clear loading message

			if (users.length === 0) {
				tbody.innerHTML = '<tr><td colspan="4">No users found.</td></tr>';
				return;
			}

			users.forEach(user => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${escapeHtml(user.username)}</td>
					<td>${escapeHtml(user.role)}</td>
					<td>${new Date(user.created_at).toLocaleDateString()}</td>
					<td>
						<button class="btn btn-danger" onclick="deleteUser(${user.id}, '${escapeHtml(user.username)}')" style="padding: 5px 10px; font-size: 12px;">Delete</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		} catch (error) {
			tbody.innerHTML = '<tr><td colspan="4">Failed to load users.</td></tr>';
			showNotification('Could not load users. You might not have admin rights.', 'error');
		}
	}

	// Delete a user
	async function deleteUser(id, username) {
		if (!confirm(`Are you sure you want to delete the user "${username}"? This action cannot be undone.`)) {
			return;
		}
		try {
			const response = await apiCall(`/users/${id}`, { method: 'DELETE' });
			
			if (response.status === 204) {
				showNotification(`User "${username}" deleted successfully.`, 'success');
				await showUserList(); // Refresh the list
			} else {
				const data = await response.json();
				throw new Error(data.error || 'Failed to delete user.');
			}
		} catch (error) {
			showNotification(error.message, 'error');
		}
	}

	// Change password for the current user
	async function changePassword(event) {
		event.preventDefault();
		const currentPassword = document.getElementById('currentPassword').value;
		const newPassword = document.getElementById('newPassword').value;
		const confirmPassword = document.getElementById('confirmPassword').value;

		if (newPassword !== confirmPassword) {
			showNotification('New passwords do not match.', 'error');
			return;
		}
		if (newPassword.length < 6) {
			showNotification('New password must be at least 6 characters long.', 'warning');
			return;
		}

		try {
			const response = await apiCall('/auth/change-password', {
				method: 'PUT',
				body: JSON.stringify({ currentPassword, newPassword })
			});
			const data = await response.json();

			if (!response.ok) {
				throw new Error(data.error || 'Failed to change password.');
			}

			showNotification(data.message, 'success');
			// Clear password fields
			document.getElementById('currentPassword').value = '';
			document.getElementById('newPassword').value = '';
			document.getElementById('confirmPassword').value = '';
		} catch (error) {
			showNotification(error.message, 'error');
		}
	}
		
	// --- Report Generation Functions ---

		// Helper function to display report data in the table
		function displayReportResults(data) {
			const table = document.getElementById('reportTable');
			const tbody = table.querySelector('tbody');
			const noResults = document.getElementById('noResults');
			tbody.innerHTML = '';

			if (!data || data.length === 0) {
				table.style.display = 'none';
				noResults.style.display = 'block';
				return;
			}
			
			table.style.display = 'table';
			noResults.style.display = 'none';
			
			data.forEach(item => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${escapeHtml(item.owner_name || '-')}</td>
					<td>${escapeHtml(item.token_number || '-')}</td>
					<td>${escapeHtml(item.location || '-')}</td>
					<td>${formatCurrency(item.total_payment || 0)}</td>
					<td>${formatCurrency(item.payment_due || 0)}</td>
					<td>${escapeHtml(item.agent_name || '-')}</td>
				`;
				tbody.appendChild(row);
			});
		}

		// Function to generate report by agent
		async function generateReportByAgent() {
			const agentName = document.getElementById('reportAgentName').value;
			if (!agentName) {
				showNotification('Please select an agent.', 'warning');
				return;
			}
			try {
				const response = await apiCall(`/reports?agentName=${encodeURIComponent(agentName)}`);
				const data = await response.json();
				displayReportResults(data);
			} catch (error) {
				showNotification('Error generating agent report.', 'error');
			}
		}

		// Function to generate report of expiring agreements
		async function generateExpiringReport() {
			const fromDate = document.getElementById('expiryFromDate').value;
			const toDate = document.getElementById('expiryToDate').value;
			if (!fromDate || !toDate) {
				showNotification('Please select both a "From" and "To" date.', 'warning');
				return;
			}
			try {
				const response = await apiCall(`/reports?expiryFromDate=${fromDate}&expiryToDate=${toDate}`);
				const data = await response.json();
				displayReportResults(data);
			} catch (error) {
				showNotification('Error generating expiring report.', 'error');
			}
		}

		// Function to generate report by pending amount
		async function generatePendingReport() {
			const pendingFilter = document.getElementById('pendingAmountFilter').value;
			if (!pendingFilter) {
				showNotification('Please select a condition for pending amount.', 'warning');
				return;
			}
			try {
				const response = await apiCall(`/reports?pendingAmount=${pendingFilter}`);
				const data = await response.json();
				displayReportResults(data);
			} catch (error) {
				showNotification('Error generating pending amount report.', 'error');
			}
		}

		// Function to generate profit report
		async function generateProfitReport() {
			const fromDate = document.getElementById('profitFromDate').value;
			const toDate = document.getElementById('profitToDate').value;
			const agentName = document.getElementById('profitAgentFilter').value;
			
			if (!fromDate || !toDate) {
				showNotification('Please select both a "From" and "To" date for the profit report.', 'warning');
				return;
			}
			
			let query = `fromDate=${fromDate}&toDate=${toDate}`;
			if (agentName) {
				query += `&agentName=${encodeURIComponent(agentName)}`;
			}
			
			try {
				const response = await apiCall(`/reports/profit?${query}`);
				const data = await response.json();
				
				// Update summary cards
				document.getElementById('profitSummary').style.display = 'block';
				document.getElementById('totalRevenue').textContent = formatCurrency(data.summary.total_revenue || 0);
				document.getElementById('totalProfit').textContent = formatCurrency(data.summary.total_profit || 0);
				document.getElementById('averageMargin').textContent = `${parseFloat(data.summary.average_margin || 0).toFixed(2)}%`;
				document.getElementById('topAgent').textContent = data.topAgent || '-';
				
				// Display detailed data in the main report table
				displayReportResults(data.details);
				
			} catch (error) {
				showNotification('Error generating profit report.', 'error');
			}
		}

		// Functions to clear filters
		function clearAgentFilter() {
			document.getElementById('reportAgentName').value = '';
			displayReportResults([]);
		}
		function clearExpiryFilter() {
			document.getElementById('expiryFromDate').value = '';
			document.getElementById('expiryToDate').value = '';
			displayReportResults([]);
		}
		function clearPendingFilter() {
			document.getElementById('pendingAmountFilter').value = '';
			displayReportResults([]);
		}
		function clearProfitFilter() {
			document.getElementById('profitFromDate').value = '';
			document.getElementById('profitToDate').value = '';
			document.getElementById('profitAgentFilter').value = '';
			document.getElementById('profitSummary').style.display = 'none';
			displayReportResults([]);
		}
			
	async function saveEditedAgreement() {
		const id = document.getElementById('editAgreementId').value;
		const editForm = document.getElementById('editFormGrid');

		// Collect data from the edit form
		const updatedData = {};
		agreementFormFields.forEach(fieldId => {
			const element = editForm.querySelector(`#${fieldId}`);
			if (element) {
				updatedData[fieldId] = element.value;
			}
		});

		// Remap camelCase keys to snake_case if your backend expects that (it does not, but good practice)
		// For this specific app, the body keys are camelCase as per your `collectAgreementData` function
		const body = {
			ownerName: updatedData.ownerName,
			location: updatedData.location,
			tokenNumber: updatedData.tokenNumber,
			agreementDate: updatedData.agreementDate,
			ownerContact: updatedData.ownerContact,
			tenantContact: updatedData.tenantContact,
			email: updatedData.email,
			expiryDate: updatedData.expiryDate,
			reminderDate: updatedData.reminderDate,
			ccEmail: updatedData.ccEmail,
			agentName: updatedData.agentName,
			totalPayment: updatedData.totalPayment,
			paymentOwner: updatedData.paymentOwner,
			paymentTenant: updatedData.paymentTenant,
			paymentDue: updatedData.paymentDue,
			agreementStatus: updatedData.agreementStatus,
			biometricDate: updatedData.biometricDate,
			actualCost: updatedData.actualCost,
			agentCommission: updatedData.agentCommission,
			otherExpenses: updatedData.otherExpenses,
		};
		
		try {
			const response = await apiCall(`/agreements/${id}`, {
				method: 'PUT',
				body: JSON.stringify(body),
			});

			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || 'Failed to save changes.');
			}

			showNotification('Agreement updated successfully!', 'success');
			closeEditModal();
			await loadAgreements(); // Refresh the main table

		} catch (error) {
			console.error('Save changes error:', error);
			showNotification(error.message, 'error');
		}
	}

		function closeEditModal() {
			document.getElementById('editModal').style.display = 'none';
		}

		// Utility functions
		function escapeHtml(text) {
			if (!text) return '';
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function formatCurrency(amount) {
			return `₹${parseFloat(amount).toFixed(2)}`;
		}

		function formatDate(dateString) {
			if (!dateString) return '-';
			const date = new Date(dateString);
			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();
			return `${day}-${month}-${year}`;
		}

		// Load system settings
		async function loadSystemSettings() {
			try {
				const response = await apiCall('/settings');
				console.log('Settings response:', response);
				
				if (response && typeof response === 'object') {
					// Update settings form if it exists
					if (document.getElementById('defaultCCEmail')) {
						const ccEmail = response.default_cc_email || response.ccEmail || 'support@ramnathshetty.com';
						document.getElementById('defaultCCEmail').value = ccEmail;
						document.getElementById('ccEmail').value = ccEmail;
					}
				}
			} catch (error) {
				console.error('Error loading settings:', error);
				// Settings might not be critical, so don't show error
			}
		}

    // Load activity logs
    async function loadActivityLogs() {
        try {
            const response = await apiCall('/activity-logs?limit=50');
            const logs = await response.json();
            const container = document.getElementById('logsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<p>No activity logs found.</p>';
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #3498db;">
                    <strong>${new Date(log.created_at).toLocaleString()}</strong> - 
                    <strong>${log.username}</strong>: ${log.action} - ${log.details}
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading logs:', error);
            document.getElementById('logsContainer').innerHTML = '<p>Error loading activity logs.</p>';
        }
    }

    // Load agents for reports
    async function loadAgentsForReports() {
        try {
            const response = await apiCall('/agents');
            const agents = await response.json();
            
            const agentSelects = document.querySelectorAll('#reportAgentName, #profitAgentFilter');
            agentSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Select Agent</option>' + 
                        agents.map(agent => `<option value="${agent.name}">${agent.name}</option>`).join('');
                }
            });
        } catch (error) {
            console.error('Error loading agents:', error);
        }
    }

    // Export data function
    async function exportData() {
        try {
            showNotification('Exporting data...', 'warning');
            
            const response = await apiCall('/agreements');
            const agreements = await response.json();
            
            if (agreements.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            // Simple CSV export
            const headers = ['Owner Name', 'Location', 'Token Number', 'Agreement Date', 'Expiry Date', 'Agent', 'Total Payment', 'Payment Due', 'Status'];
            const csvData = agreements.map(agreement => [
                `"${agreement.owner_name}"`,
                `"${agreement.location}"`,
                `"${agreement.token_number}"`,
                agreement.agreement_date,
                agreement.expiry_date,
                `"${agreement.agent_name}"`,
                agreement.total_payment,
                agreement.payment_due,
                `"${agreement.agreement_status}"`
            ]);
            
            const csvContent = [headers.join(','), ...csvData.map(row => row.join(','))].join('\n');
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agreements_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
            
        } catch (error) {
            console.error('Export error:', error);
            showNotification('Error exporting data', 'error');
        }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        if (document.getElementById('buildDate')) {
            document.getElementById('buildDate').textContent = new Date().toISOString().split('T')[0];
        }
    });
</script>
</body>
</html>