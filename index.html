<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agreement Manager - Cloud Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Form Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* Main App Styles */
        .main-app {
            display: none;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        .form-field label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow-x: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: block;
            white-space: nowrap;
        }

        .data-table thead,
        .data-table tbody,
        .data-table tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .data-table thead {
            width: calc(100% - 1em);
        }

        .data-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            width: auto;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            width: auto;
        }

        .data-table tbody {
            height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Specific column widths for better display */
        .data-table th:nth-child(1), .data-table td:nth-child(1) { width: 15%; }
        .data-table th:nth-child(2), .data-table td:nth-child(2) { width: 12%; }
        .data-table th:nth-child(3), .data-table td:nth-child(3) { width: 15%; }
        .data-table th:nth-child(4), .data-table td:nth-child(4) { width: 12%; }
        .data-table th:nth-child(5), .data-table td:nth-child(5) { width: 12%; }
        .data-table th:nth-child(6), .data-table td:nth-child(6) { width: 10%; }
        .data-table th:nth-child(7), .data-table td:nth-child(7) { width: 12%; }
        .data-table th:nth-child(8), .data-table td:nth-child(8) { width: 12%; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #2ecc71; }
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1>Agreement Manager</h1>
            <div class="debug-info">
                <strong>Test Credentials:</strong><br>
                Username: admin<br>
                Password: admin123
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
			<div class="form-group">
				<label for="username">Username</label>
				<input type="text" id="username" name="username" placeholder="Enter username (try: admin)" autocomplete="username" required>
			</div>
			<div class="form-group">
				<label for="password">Password</label>
				<input type="password" id="password" name="password" placeholder="Enter password (try: admin123)" autocomplete="current-password" required>
			</div>
			<button type="submit" class="login-btn">Login</button>
		</form>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <div class="container">
            <div class="header">
                <h1>Agreement Manager - Cloud Edition</h1>
                <div class="user-info">
                    <span>Welcome, <span id="currentUser">User</span></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('agreements', this)">Agreements</button>
                <button class="tab" onclick="showTab('reports', this)">Reports</button>
                <button class="tab" onclick="showTab('whatsapp', this)">WhatsApp</button>
                <button class="tab" onclick="showTab('logs', this)">Activity Logs</button>
                <button class="tab" onclick="showTab('settings', this)">Settings</button>
            </div>

            <!-- Agreements Tab -->
            <div class="tab-content active" id="agreements">
                <h2>Agreement Management</h2>
                
                <div class="form-grid">
                    <div class="form-field">
                        <label for="ownerName">Name of Owner</label>
                        <input type="text" id="ownerName" placeholder="Enter owner name">
                    </div>
                    <div class="form-field">
                        <label for="location">Location</label>
                        <input type="text" id="location" placeholder="Enter property location">
                    </div>
                    <div class="form-field">
                        <label for="tokenNumber">Token Number</label>
                        <input type="text" id="tokenNumber" placeholder="Enter token number">
                    </div>
                    <div class="form-field">
                        <label for="agreementDate">Agreement Date</label>
                        <input type="date" id="agreementDate">
                    </div>
                    <div class="form-field">
                        <label for="ownerContact">Owner Contact</label>
                        <input type="tel" id="ownerContact" placeholder="Enter owner contact number">
                    </div>
                    <div class="form-field">
                        <label for="tenantContact">Tenant Contact</label>
                        <input type="tel" id="tenantContact" placeholder="Enter tenant contact number">
                    </div>
                    <div class="form-field">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="Enter email address">
                    </div>
                    <div class="form-field">
                        <label for="expiryDate">Expiry Date</label>
                        <input type="date" id="expiryDate">
                    </div>
                    <div class="form-field">
                        <label for="reminderDate">Reminder Date</label>
                        <input type="date" id="reminderDate">
                    </div>
                    <div class="form-field">
                        <label for="ccEmail">CC Email</label>
                        <input type="email" id="ccEmail" value="support@ramnathshetty.com" readonly>
                    </div>
                    <div class="form-field">
                        <label for="agentName">Agent Name</label>
                        <select id="agentName" title="Select agent name">
                            <option value="">Select Agent</option>
                            <option value="Ramnath">Ramnath</option>
                            <option value="Agent 1">Agent 1</option>
                            <option value="Agent 2">Agent 2</option>
                            <option value="Agent 3">Agent 3</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="totalPayment">Total Payment</label>
                        <input type="number" id="totalPayment" step="0.01" placeholder="Enter total payment amount" onchange="calculateDue()">
                    </div>
                    <div class="form-field">
                        <label for="paymentOwner">Pymnt Rcvd from Owner</label>
                        <input type="number" id="paymentOwner" step="0.01" placeholder="Enter payment from owner" onchange="calculateDue()">
                    </div>
                    <div class="form-field">
                        <label for="paymentTenant">Pymnt Rcvd from Tenant</label>
                        <input type="number" id="paymentTenant" step="0.01" placeholder="Enter payment from tenant" onchange="calculateDue()">
                    </div>
                    <div class="form-field">
                        <label for="paymentReceivedDate1">Pymt Rcvd Dt1</label>
                        <input type="date" id="paymentReceivedDate1">
                    </div>
                    <div class="form-field">
                        <label for="paymentReceivedDate2">Pymt Rcvd Dt2</label>
                        <input type="date" id="paymentReceivedDate2">
                    </div>
                    <div class="form-field">
                        <label for="paymentDue">Payment Due (Auto-calculated)</label>
                        <input type="number" id="paymentDue" step="0.01" readonly placeholder="Auto-calculated">
                    </div>
                    <div class="form-field">
                        <label for="agreementStatus">Agreement Status</label>
                        <select id="agreementStatus" title="Select agreement status">
                            <option value="Drafted">Drafted</option>
                            <option value="Sent to Client">Sent to Client</option>
                            <option value="Biometric Scheduled">Biometric Scheduled</option>
                            <option value="Biometrics Completed">Biometrics Completed</option>
                            <option value="Send Final Draft to Client">Send Final Draft to Client</option>
                            <option value="Submitted">Submitted</option>
                            <option value="Registered">Registered</option>
                            <option value="Registered agreement sent to the client">Registered agreement sent to the client</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="biometricDate">Biometric Scheduled Date</label>
                        <input type="date" id="biometricDate">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveAgreement()">Add Agreement</button>
                    <button class="btn btn-success" onclick="exportData()">Export All Data (CSV)</button>
                    <button class="btn btn-warning" onclick="showNotification('Test notification works!', 'warning')">Test Notification</button>
                </div>

                <div style="overflow-x: auto; margin-bottom: 20px;">
                    <table class="data-table" id="agreementsTable" style="min-width: 1200px;">
                        <thead>
                            <tr>
                                <th style="width: 150px;">Name of Owner</th>
                                <th style="width: 120px;">Location</th>
                                <th style="width: 100px;">Token Number</th>
                                <th style="width: 120px;">Owner Contact</th>
                                <th style="width: 120px;">Tenant Contact</th>
                                <th style="width: 100px;">Agent</th>
                                <th style="width: 120px;">Total Payment</th>
                                <th style="width: 120px;">Payment Due</th>
                                <th style="width: 120px;">Status</th>
                                <th style="width: 100px;">Expiry Date</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
			
			<!-- Add these to your form-grid in the Agreements tab -->

		<!-- Profit Calculation Section -->
		<div class="form-field">
			<label for="actualCost">Actual Cost/Expenses</label>
			<input type="number" id="actualCost" step="0.01" placeholder="Enter actual expenses" onchange="calculateProfit()">
		</div>

		<div class="form-field">
			<label for="agentCommission">Agent Commission</label>
			<input type="number" id="agentCommission" step="0.01" placeholder="Enter agent commission" onchange="calculateProfit()">
		</div>

		<div class="form-field">
			<label for="otherExpenses">Other Expenses</label>
			<input type="number" id="otherExpenses" step="0.01" placeholder="Enter other expenses" onchange="calculateProfit()">
		</div>

		<!-- Profit Display Fields (Read-only) -->
		<div class="form-field">
			<label for="grossProfit">Gross Profit (Auto-calculated)</label>
			<input type="number" id="grossProfit" step="0.01" readonly placeholder="Gross profit will appear here">
		</div>

		<div class="form-field">
			<label for="netProfit">Net Profit (Auto-calculated)</label>
			<input type="number" id="netProfit" step="0.01" readonly placeholder="Net profit will appear here">
		</div>

		<div class="form-field">
			<label for="profitMargin">Profit Margin % (Auto-calculated)</label>
			<input type="number" id="profitMargin" step="0.01" readonly placeholder="Profit margin will appear here">
		</div>

            <!-- Reports Tab -->
            <div class="tab-content" id="reports">
                <h2>Reports & Analytics</h2>
                <p style="margin-bottom: 20px; font-weight: 600; color: #2c3e50;">Select a filter to generate a report:</p>
                
                <!-- Filter by Agent -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #3498db;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Filter by Agent</h4>
                    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                        <div class="form-field" style="min-width: 200px;">
                            <label for="reportAgentName">Agent Name:</label>
                            <select id="reportAgentName">
                                <option value="">Select Agent</option>
                                <option value="Ramnath">Ramnath</option>
                                <option value="Agent 1">Agent 1</option>
                                <option value="Agent 2">Agent 2</option>
                                <option value="Agent 3">Agent 3</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="generateReportByAgent()">Generate Report by Agent</button>
                        <button class="btn btn-warning" onclick="clearAgentFilter()">Clear</button>
                    </div>
                </div>
				
				<!-- Profit Reports Section -->
				<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
					<h4 style="color: #2c3e50; margin-bottom: 15px;">💰 Profit Analysis Reports</h4>
					<div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
						<div class="form-field">
							<label for="profitFromDate">From Date:</label>
							<input type="date" id="profitFromDate">
						</div>
						<div class="form-field">
							<label for="profitToDate">To Date:</label>
							<input type="date" id="profitToDate">
						</div>
						<div class="form-field">
							<label for="profitAgentFilter">Filter by Agent:</label>
							<select id="profitAgentFilter">
								<option value="">All Agents</option>
								<option value="Ramnath">Ramnath</option>
								<option value="Agent 1">Agent 1</option>
								<option value="Agent 2">Agent 2</option>
							</select>
						</div>
						<button class="btn btn-success" onclick="generateProfitReport()">Generate Profit Report</button>
						<button class="btn btn-warning" onclick="clearProfitFilter()">Clear</button>
					</div>
				</div>

				<!-- Profit Summary Cards -->
				<div id="profitSummary" style="display: none; margin-bottom: 20px;">
					<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
						<div style="background: #2ecc71; color: white; padding: 20px; border-radius: 10px; text-align: center;">
							<h4>Total Revenue</h4>
							<h3 id="totalRevenue">₹0.00</h3>
						</div>
						<div style="background: #3498db; color: white; padding: 20px; border-radius: 10px; text-align: center;">
							<h4>Total Profit</h4>
							<h3 id="totalProfit">₹0.00</h3>
						</div>
						<div style="background: #9b59b6; color: white; padding: 20px; border-radius: 10px; text-align: center;">
							<h4>Average Margin</h4>
							<h3 id="averageMargin">0%</h3>
						</div>
						<div style="background: #e74c3c; color: white; padding: 20px; border-radius: 10px; text-align: center;">
							<h4>Most Profitable Agent</h4>
							<h3 id="topAgent">-</h3>
						</div>
					</div>
				</div>

                <!-- Expiring Agreements -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #e74c3c;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Expiring Agreements</h4>
                    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                        <div class="form-field">
                            <label for="expiryFromDate">From:</label>
                            <input type="date" id="expiryFromDate">
                        </div>
                        <div class="form-field">
                            <label for="expiryToDate">To:</label>
                            <input type="date" id="expiryToDate">
                        </div>
                        <button class="btn btn-danger" onclick="generateExpiringReport()">Generate Expiring Agreements Report</button>
                        <button class="btn btn-warning" onclick="clearExpiryFilter()">Clear</button>
                    </div>
                </div>

                <!-- Filter by Pending Amount -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #f39c12;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Filter by Pending Amount</h4>
                    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                        <div class="form-field" style="min-width: 200px;">
                            <label for="pendingAmountFilter">Pending Amount:</label>
                            <select id="pendingAmountFilter">
                                <option value="">Select Condition</option>
                                <option value="greater">Greater than zero</option>
                                <option value="less">Less than zero</option>
                            </select>
                        </div>
                        <button class="btn btn-warning" onclick="generatePendingReport()">Generate Pending Report</button>
                        <button class="btn btn-warning" onclick="clearPendingFilter()">Clear</button>
                    </div>
                </div>

                <!-- Export Button -->
                <div style="margin-bottom: 25px;">
                    <button class="btn btn-success" onclick="exportReport()">Export Report to Excel</button>
                </div>

                <!-- Report Results Table -->
                <div style="overflow-x: auto;">
                    <table class="data-table" id="reportTable" style="display: none; min-width: 800px;">
                        <thead>
                            <tr style="background: #e74c3c;">
                                <th style="width: 150px;">Name of Owner</th>
                                <th style="width: 120px;">Token Number</th>
                                <th style="width: 150px;">Location</th>
                                <th style="width: 130px;">Total Amount Charged</th>
                                <th style="width: 120px;">Payment Due</th>
                                <th style="width: 120px;">Agent Name</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- No Results Message -->
                <div id="noResults" style="display: none; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; color: #666;">
                    <p>No records found matching the selected criteria.</p>
                    <p>Try adjusting your filter options and generate the report again.</p>
                </div>
            </div>

            <!-- WhatsApp Tab -->
            <div class="tab-content" id="whatsapp">
                <h2>WhatsApp Notifications</h2>
                <p>WhatsApp integration will be available here.</p>
            </div>

            <!-- Activity Logs Tab -->
            <div class="tab-content" id="logs">
                <h2>Activity Logs</h2>
                <div id="logsContainer">
                    <p>Activity logs will appear here after you perform actions.</p>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <h2>System Settings & Administration</h2>
                
          
                <!-- User Management Section -->
				<div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #3498db;">
					<h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
						<span style="margin-right: 10px;">👥</span> User Management
					</h3>
					
					<!-- Add User Form -->
						<form onsubmit="addNewUser(event)">
							<div class="form-grid" style="margin-bottom: 20px;">
								<div class="form-field">
									<label for="newUsername">New Username</label>
									<input type="text" id="newUsername" placeholder="Enter username" required>
								</div>
								<div class="form-field">
									<label for="newUserPassword">Password</label>
									<input type="password" id="newUserPassword" placeholder="Enter password" required autocomplete="new-password">
								</div>
								<div class="form-field">
									<label for="newUserRole">User Role</label>
									<select id="newUserRole" required>
										<option value="user">User</option>
										<option value="admin">Administrator</option>
										<option value="agent">Agent</option>
										<option value="manager">Manager</option>
									</select>
								</div>
							</div>

							<div class="btn-group">
								<button type="submit" class="btn btn-success">Add User</button>
								<button type="button" class="btn btn-warning" onclick="showUserList()">Manage Users</button>
							</div>
						</form>

						<!-- Change Password Form -->
						<form onsubmit="changePassword(event)" style="margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
							<h4>Change Password</h4>
							<div style="margin-bottom: 15px;">
								<label for="currentPassword">Current Password:</label>
								<input type="password" id="currentPassword" autocomplete="current-password" required>
							</div>
							<div style="margin-bottom: 15px;">
								<label for="newPassword">New Password:</label>
								<input type="password" id="newPassword" autocomplete="new-password" required>
							</div>
							<div style="margin-bottom: 15px;">
								<label for="confirmPassword">Confirm New Password:</label>
								<input type="password" id="confirmPassword" autocomplete="new-password" required>
							</div>
							<button type="submit" class="btn btn-warning">Change Password</button>
						</form>

					
					<!-- User List Table -->
					<div id="userListContainer" style="margin-top: 20px; display: none;">
						<h4>Current Users:</h4>
						<table class="data-table" id="usersTable" style="margin-top: 10px;">
							<thead>
								<tr>
									<th>Username</th>
									<th>Role</th>
									<th>Created Date</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>

                <!-- Backup & Restore Section -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #e74c3c;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">💾</span> Backup & Restore
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Backup Section -->
                        <div>
                            <h4 style="margin-bottom: 15px;">Create Backup</h4>
                            <p style="margin-bottom: 15px; color: #666;">Download a complete backup of all your data including agreements, users, and settings.</p>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="createBackup()">Create Full Backup</button>
                            </div>
                        </div>
                        
                        <!-- Restore Section -->
                        <div>
                            <h4 style="margin-bottom: 15px;">Restore from Backup</h4>
                            <p style="margin-bottom: 15px; color: #666;">Import data from a previously created backup file.</p>
                            <input type="file" id="backupFileInput" accept=".json,.csv" style="margin-bottom: 15px;">
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="restoreFromBackup()">Restore Data</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Configuration -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #27ae60;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">⚙️</span> System Configuration
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="defaultCCEmail">Default CC Email</label>
                            <input type="email" id="defaultCCEmail" value="support@ramnathshetty.com">
                        </div>
                        <div class="form-field">
                            <label for="companyName">Company Name</label>
                            <input type="text" id="companyName" value="Shetty Legal Advisors">
                        </div>
                        <div class="form-field">
                            <label for="reminderDaysBefore">Reminder Days Before Expiry</label>
                            <input type="number" id="reminderDaysBefore" value="30" min="1" max="365">
                        </div>
                        <div class="form-field">
                            <label for="dateFormat">Date Format</label>
                            <select id="dateFormat">
                                <option value="DD-MM-YYYY">DD-MM-YYYY (Indian)</option>
                                <option value="MM-DD-YYYY">MM-DD-YYYY (US)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="currencySymbol">Currency Symbol</label>
                            <select id="currencySymbol">
                                <option value="₹">₹ (Indian Rupee)</option>
                                <option value="$">$ (US Dollar)</option>
                                <option value="€">€ (Euro)</option>
                                <option value="£">£ (British Pound)</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="maxRecordsPerPage">Records Per Page</label>
                            <select id="maxRecordsPerPage">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveSystemSettings()">Save Settings</button>
                    </div>
                </div>

                <!-- Security & Maintenance -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #f39c12;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">🔒</span> Security & Maintenance
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Security Settings -->
                        <div>
                            <h4 style="margin-bottom: 15px;">Security Settings</h4>
                            <div style="margin-bottom: 15px;">
                                <label for="sessionTimeout">Session Timeout (minutes)</label>
                                <input type="number" id="sessionTimeout" value="60" min="5" max="480">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label>
                                    <input type="checkbox" id="forcePasswordChange"> Force password change on first login
                                </label>
                            </div>
                            <button class="btn btn-warning" onclick="changePassword()">Change My Password</button>
                        </div>
                        
                        <!-- Maintenance -->
                        <div>
                            <h4 style="margin-bottom: 15px;">System Maintenance</h4>
                            <div style="margin-bottom: 15px;">
                                <p style="color: #666; font-size: 14px;">Total Agreements: <span id="totalAgreements">0</span></p>
                                <p style="color: #666; font-size: 14px;">Total Users: <span id="totalUsers">0</span></p>
                                <p style="color: #666; font-size: 14px;">Database Size: <span id="databaseSize">~2MB</span></p>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="refreshData()">Refresh Data</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; border-left: 4px solid #9b59b6;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">ℹ️</span> System Information
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4 style="margin-bottom: 15px;">Application Details</h4>
                            <p><strong>Version:</strong> 1.0.0</p>
                            <p><strong>Build Date:</strong> <span id="buildDate">2024-09-24</span></p>
                            <p><strong>Current User:</strong> <span id="currentUserInfo">admin</span></p>
                            <p><strong>Login Time:</strong> <span id="loginTime">-</span></p>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px;">License & Support</h4>
                            <p><strong>Licensed to:</strong> Shetty Legal Advisors</p>
                            <p><strong>Support Email:</strong> support@ramnathshetty.com</p>
                            <p><strong>Last Backup:</strong> <span id="lastBackupTime">Never</span></p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="checkForUpdates()">Check for Updates</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Agreement</h2>
            <div class="form-grid" id="editFormGrid">
                <!-- Edit form fields will be populated here -->
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveEditedAgreement()">Save Changes</button>
                <button class="btn btn-danger" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Cloud-based API functions
        const API_BASE_URL = '/api';

        // Authentication functions
        async function handleLogin(event) {
			if (event) event.preventDefault();
			
			const username = document.getElementById('username').value;
			const password = document.getElementById('password').value;

			if (!username || !password) {
				showNotification('Please enter both username and password', 'error');
				return;
			}

			try {
				console.log('Attempting login for user:', username);
				
				const response = await fetch('/api/auth/login', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ username, password })
				});

				const responseData = await response.json();
				console.log('Login response:', responseData);

				if (response.ok) {
					localStorage.setItem('authToken', 'agreement-manager-token');
					localStorage.setItem('currentUser', username);
					
					showNotification('Login successful!', 'success');
					document.getElementById('loginContainer').style.display = 'none';
					document.getElementById('mainApp').style.display = 'block';
					document.getElementById('currentUser').textContent = username;
					document.getElementById('currentUserInfo').textContent = username;
					document.getElementById('loginTime').textContent = new Date().toLocaleString();
					
					// Load initial data
					await loadAgreements();
				} else {
					throw new Error(responseData.error || 'Login failed');
				}
			} catch (error) {
				console.error('Login error:', error);
				showNotification(error.message || 'Login failed. Please check credentials.', 'error');
			}
		}

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showNotification('Logged out successfully', 'success');
        }

        // Check authentication on page load
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            
            if (token && user) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUser').textContent = user;
                document.getElementById('currentUserInfo').textContent = user;
                document.getElementById('loginTime').textContent = new Date().toLocaleString();
                loadAgreements();
            }
        }

        // API call helper function
        async function apiCall(endpoint, options = {}) {
			const token = localStorage.getItem('authToken');
			const defaultOptions = {
				headers: {
					'Authorization': `Bearer ${token}`,
					'Content-Type': 'application/json',
					...options.headers
				}
			};

			try {
				console.log('API Call:', endpoint, options);
				const response = await fetch(`/api${endpoint}`, { ...defaultOptions, ...options });
				
				if (response.status === 401) {
					logout();
					throw new Error('Authentication required');
				}
				
				return response;
			} catch (error) {
				console.error('API call error:', error);
				showNotification('Network error. Please try again.', 'error');
				throw error;
			}
		}
		
		async function testConnection() {
			try {
				const response = await fetch('/api/test');
				const data = await response.json();
				console.log('Connection test:', data);
				return true;
			} catch (error) {
				console.error('Connection test failed:', error);
				return false;
			}
		}

		// Test on page load
		document.addEventListener('DOMContentLoaded', function() {
			testConnection().then(success => {
				if (success) {
					console.log('✅ Backend connection successful');
				} else {
					console.log('❌ Backend connection failed');
					showNotification('Cannot connect to server. Please check if the backend is running.', 'error');
				}
				checkAuth();
			});
		});
						
		async function exportData() {
			try {
				showNotification('Exporting data...', 'warning');
				
				const response = await apiCall('/api/agreements');
				const agreements = await response.json();
				
				if (agreements.length === 0) {
					showNotification('No data to export', 'warning');
					return;
				}
				
				// Convert to CSV
				const headers = ['Owner Name', 'Location', 'Token Number', 'Agreement Date', 'Expiry Date', 'Agent', 'Total Payment', 'Payment Due', 'Status', 'Net Profit'];
				const csvData = agreements.map(agreement => [
					`"${agreement.owner_name}"`,
					`"${agreement.location}"`,
					`"${agreement.token_number}"`,
					agreement.agreement_date,
					agreement.expiry_date,
					`"${agreement.agent_name}"`,
					agreement.total_payment,
					agreement.payment_due,
					`"${agreement.agreement_status}"`,
					agreement.net_profit
				]);
				
				const csvContent = [headers.join(','), ...csvData.map(row => row.join(','))].join('\n');
				
				// Download file
				const blob = new Blob([csvContent], { type: 'text/csv' });
				const url = window.URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `agreements_export_${new Date().toISOString().split('T')[0]}.csv`;
				a.click();
				window.URL.revokeObjectURL(url);
				
				showNotification('Data exported successfully!', 'success');
				await logActivity('Data Export', 'Exported all agreements to CSV');
				
			} catch (error) {
				console.error('Export error:', error);
				showNotification('Error exporting data', 'error');
			}
		}
		
		async function generateProfitReport() {
			try {
				const fromDate = document.getElementById('profitFromDate').value;
				const toDate = document.getElementById('profitToDate').value;
				const agentFilter = document.getElementById('profitAgentFilter').value;
				
				if (!fromDate || !toDate) {
					showNotification('Please select both from and to dates', 'warning');
					return;
				}
				
				showNotification('Generating profit report...', 'warning');
				
				let url = `/api/reports/profit?from=${fromDate}&to=${toDate}`;
				if (agentFilter) {
					url += `&agent=${encodeURIComponent(agentFilter)}`;
				}
				
				const response = await apiCall(url);
				const data = await response.json();
				
				await displayReportResults(data, `Profit Report: ${fromDate} to ${toDate}`);
				
				// Generate profit summary
				await generateProfitSummary(data);
				
			} catch (error) {
				console.error('Profit report error:', error);
				showNotification('Error generating profit report', 'error');
			}
		}

		async function generateProfitSummary(data) {
			try {
				const totalRevenue = data.reduce((sum, item) => sum + (item.total_payment || 0), 0);
				const totalProfit = data.reduce((sum, item) => sum + (item.net_profit || 0), 0);
				const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
				
				// Find top agent
				const agentProfits = {};
				data.forEach(item => {
					const agent = item.agent_name || 'Unknown';
					agentProfits[agent] = (agentProfits[agent] || 0) + (item.net_profit || 0);
				});
				
				const topAgent = Object.keys(agentProfits).reduce((a, b) => 
					agentProfits[a] > agentProfits[b] ? a : b, 'None'
				);
				
				// Update summary cards
				document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toFixed(2)}`;
				document.getElementById('totalProfit').textContent = `₹${totalProfit.toFixed(2)}`;
				document.getElementById('averageMargin').textContent = `${avgMargin.toFixed(2)}%`;
				document.getElementById('topAgent').textContent = topAgent;
				
				document.getElementById('profitSummary').style.display = 'grid';
				
			} catch (error) {
				console.error('Profit summary error:', error);
			}
}
		async function addNewUser(event) {
			if (event) event.preventDefault();
			
			try {
				const username = document.getElementById('newUsername').value.trim();
				const password = document.getElementById('newUserPassword').value;
				const role = document.getElementById('newUserRole').value;
				
				if (!username || !password) {
					showNotification('Please enter username and password', 'error');
					return;
				}
				
				if (password.length < 4) {
					showNotification('Password must be at least 4 characters', 'error');
					return;
				}
				
				showNotification('Adding new user...', 'warning');
				
				const response = await apiCall('/users', {
					method: 'POST',
					body: JSON.stringify({ username, password, role })
				});
				
				if (response.ok) {
					showNotification('User added successfully!', 'success');
					// Reset the form
					document.getElementById('newUsername').value = '';
					document.getElementById('newUserPassword').value = '';
					document.getElementById('newUserRole').value = 'user';
					
					await logActivity('User Management', `Added new user: ${username}`);
					
					// Refresh user list if visible
					if (document.getElementById('userListContainer').style.display !== 'none') {
						await showUserList();
					}
				} else {
					const error = await response.json();
					throw new Error(error.error || 'Failed to add user');
				}
				
			} catch (error) {
				console.error('Add user error:', error);
				showNotification(error.message || 'Error adding user', 'error');
			}
		}

		async function showUserList() {
			try {
				showNotification('Loading users...', 'warning');
				
				const response = await apiCall('/api/users');
				const users = await response.json();
				
				const container = document.getElementById('userListContainer');
				const tbody = document.querySelector('#usersTable tbody');
				
				tbody.innerHTML = '';
				
				users.forEach(user => {
					const row = document.createElement('tr');
					row.innerHTML = `
						<td>${escapeHtml(user.username)}</td>
						<td>${escapeHtml(user.role)}</td>
						<td>${formatDate(user.created_at)}</td>
						<td>
							<button class="btn btn-danger" onclick="deleteUser(${user.id})" style="padding: 3px 8px; font-size: 11px;">Delete</button>
						</td>
					`;
					tbody.appendChild(row);
				});
				
				container.style.display = 'block';
				showNotification('Users loaded successfully', 'success');
				
			} catch (error) {
				console.error('User list error:', error);
				showNotification('Error loading users', 'error');
			}
		}

		async function deleteUser(userId) {
			try {
				if (!confirm('Are you sure you want to delete this user?')) {
					return;
				}
				
				showNotification('Deleting user...', 'warning');
				
				const response = await apiCall(`/api/users/${userId}`, {
					method: 'DELETE'
				});
				
				if (response.ok) {
					showNotification('User deleted successfully!', 'success');
					await showUserList();
					await logActivity('User Management', `Deleted user ID: ${userId}`);
				} else {
					throw new Error('Failed to delete user');
				}
				
			} catch (error) {
				console.error('Delete user error:', error);
				showNotification('Error deleting user', 'error');
			}
		}
		async function createBackup() {
			try {
				showNotification('Creating backup...', 'warning');
				
				const responses = await Promise.all([
					apiCall('/api/agreements'),
					apiCall('/api/users'),
					apiCall('/api/settings')
				]);
				
				const [agreementsRes, usersRes, settingsRes] = responses;
				const agreements = await agreementsRes.json();
				const users = await usersRes.json();
				const settings = await settingsRes.json();
				
				const backupData = {
					version: '2.0.0',
					timestamp: new Date().toISOString(),
					agreements,
					users: users.map(u => ({ ...u, password: '***HIDDEN***' })), // Don't export passwords
					settings
				};
				
				const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
				const url = window.URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `agreement_manager_backup_${new Date().toISOString().split('T')[0]}.json`;
				a.click();
				window.URL.revokeObjectURL(url);
				
				// Update last backup time
				document.getElementById('lastBackupTime').textContent = new Date().toLocaleString();
				
				showNotification('Backup created successfully!', 'success');
				await logActivity('Backup', 'Created system backup');
				
			} catch (error) {
				console.error('Backup error:', error);
				showNotification('Error creating backup', 'error');
			}
		}

		async function restoreFromBackup() {
			try {
				const fileInput = document.getElementById('backupFileInput');
				const file = fileInput.files[0];
				
				if (!file) {
					showNotification('Please select a backup file', 'error');
					return;
				}
				
				if (!confirm('WARNING: This will replace all current data. Are you sure?')) {
					return;
				}
				
				showNotification('Restoring backup...', 'warning');
				
				const fileText = await file.text();
				const backupData = JSON.parse(fileText);
				
				// Validate backup file
				if (!backupData.agreements || !backupData.users) {
					throw new Error('Invalid backup file format');
				}
				
				// Send to server for restoration
				const response = await apiCall('/api/backup/restore', {
					method: 'POST',
					body: JSON.stringify(backupData)
				});
				
				if (response.ok) {
					showNotification('Backup restored successfully!', 'success');
					fileInput.value = '';
					
					// Reload all data
					await loadAgreements();
					await logActivity('Restore', 'Restored system from backup');
					
				} else {
					throw new Error('Failed to restore backup');
				}
				
			} catch (error) {
				console.error('Restore error:', error);
				showNotification(error.message || 'Error restoring backup', 'error');
			}
		}
		
		async function saveSystemSettings() {
			try {
				const settings = {
					default_cc_email: document.getElementById('defaultCCEmail').value,
					company_name: document.getElementById('companyName').value,
					reminder_days_before: document.getElementById('reminderDaysBefore').value,
					date_format: document.getElementById('dateFormat').value,
					currency_symbol: document.getElementById('currencySymbol').value,
					session_timeout: document.getElementById('sessionTimeout').value,
					max_records_per_page: document.getElementById('maxRecordsPerPage').value
				};
				
				showNotification('Saving settings...', 'warning');
				
				const response = await apiCall('/api/settings', {
					method: 'PUT',
					body: JSON.stringify(settings)
				});
				
				if (response.ok) {
					showNotification('Settings saved successfully!', 'success');
					await logActivity('Settings', 'Updated system settings');
				} else {
					throw new Error('Failed to save settings');
				}
				
			} catch (error) {
				console.error('Save settings error:', error);
				showNotification('Error saving settings', 'error');
			}
		}
		
		

		// Load agreements function
		async function loadAgreements() {
			try {
				const response = await apiCall('/agreements');
				const agreements = await response.json();
				await displayAgreements(agreements);
			} catch (error) {
				console.error('Error loading agreements:', error);
				showNotification('Error loading agreements', 'error');
			}
		}

		// Save agreement function
		async function saveAgreement() {
			try {
				const agreementData = collectAgreementData();
				
				if (!await validateAgreementData(agreementData)) {
					return;
				}

				showNotification('Saving agreement...', 'warning');
				
				const response = await apiCall('/agreements', {
					method: 'POST',
					body: JSON.stringify(agreementData)
				});

				if (response.ok) {
					showNotification('Agreement saved successfully!', 'success');
					await clearForm();
					await loadAgreements();
					await logActivity('Agreement Created', `Added agreement for ${agreementData.ownerName}`);
				} else {
					const error = await response.json();
					throw new Error(error.error || 'Failed to save agreement');
				}
			} catch (error) {
				console.error('Save agreement error:', error);
				showNotification(error.message || 'Error saving agreement', 'error');
			}
		}

		// Collect agreement data from form
		function collectAgreementData() {
			return {
				ownerName: document.getElementById('ownerName').value,
				location: document.getElementById('location').value,
				tokenNumber: document.getElementById('tokenNumber').value,
				agreementDate: document.getElementById('agreementDate').value,
				ownerContact: document.getElementById('ownerContact').value,
				tenantContact: document.getElementById('tenantContact').value,
				email: document.getElementById('email').value,
				expiryDate: document.getElementById('expiryDate').value,
				reminderDate: document.getElementById('reminderDate').value,
				ccEmail: document.getElementById('ccEmail').value,
				agentName: document.getElementById('agentName').value,
				totalPayment: parseFloat(document.getElementById('totalPayment').value) || 0,
				paymentOwner: parseFloat(document.getElementById('paymentOwner').value) || 0,
				paymentTenant: parseFloat(document.getElementById('paymentTenant').value) || 0,
				paymentReceivedDate1: document.getElementById('paymentReceivedDate1').value,
				paymentReceivedDate2: document.getElementById('paymentReceivedDate2').value,
				paymentDue: parseFloat(document.getElementById('paymentDue').value) || 0,
				agreementStatus: document.getElementById('agreementStatus').value,
				biometricDate: document.getElementById('biometricDate').value,
				actualCost: parseFloat(document.getElementById('actualCost').value) || 0,
				agentCommission: parseFloat(document.getElementById('agentCommission').value) || 0,
				otherExpenses: parseFloat(document.getElementById('otherExpenses').value) || 0
			};
		}

		// Modal functions
		function closeEditModal() {
			document.getElementById('editModal').style.display = 'none';
		}

		// Clear form function
		async function clearForm() {
			try {
				document.querySelectorAll('#agreements input, #agreements select').forEach(element => {
					if (element.id !== 'ccEmail' && !element.readOnly) {
						element.value = '';
					}
				});
			} catch (error) {
				console.error('Error clearing form:', error);
			}
		}

		async function changePassword(event) {
			if (event) event.preventDefault();
			
			try {
				const username = localStorage.getItem('currentUser');
				const currentPassword = document.getElementById('currentPassword').value;
				const newPassword = document.getElementById('newPassword').value;
				const confirmPassword = document.getElementById('confirmPassword').value;
				
				if (!currentPassword || !newPassword || !confirmPassword) {
					showNotification('Please fill all password fields', 'error');
					return;
				}
				
				if (newPassword !== confirmPassword) {
					showNotification('New passwords do not match', 'error');
					return;
				}
				
				if (newPassword.length < 4) {
					showNotification('Password must be at least 4 characters', 'error');
					return;
				}
				
				showNotification('Changing password...', 'warning');
				
				const response = await apiCall('/users/change-password', {
					method: 'PUT',
					body: JSON.stringify({ username, currentPassword, newPassword })
				});
				
				if (response.ok) {
					showNotification('Password changed successfully!', 'success');
					// Clear form
					document.getElementById('currentPassword').value = '';
					document.getElementById('newPassword').value = '';
					document.getElementById('confirmPassword').value = '';
					await logActivity('Security', 'Changed password');
				} else {
					const error = await response.json();
					throw new Error(error.error || 'Failed to change password');
				}
				
			} catch (error) {
				console.error('Change password error:', error);
				showNotification(error.message || 'Error changing password', 'error');
			}
		}

		async function refreshData() {
			try {
				showNotification('Refreshing data...', 'warning');
				
				await Promise.all([
					loadAgreements(),
					loadSystemSettings()
				]);
				
				// Update counters
				const agreementsResponse = await apiCall('/api/agreements');
				const agreements = await agreementsResponse.json();
				document.getElementById('totalAgreements').textContent = agreements.length;
				
				const usersResponse = await apiCall('/api/users');
				const users = await usersResponse.json();
				document.getElementById('totalUsers').textContent = users.length;
				
				showNotification('Data refreshed successfully!', 'success');
				
			} catch (error) {
				console.error('Refresh error:', error);
				showNotification('Error refreshing data', 'error');
			}
		}

		async function checkForUpdates() {
			try {
				showNotification('Checking for updates...', 'warning');
				
				// Simulate update check
				await new Promise(resolve => setTimeout(resolve, 2000));
				
				showNotification('You are running the latest version (v2.0.0)', 'success');
				
			} catch (error) {
				console.error('Update check error:', error);
				showNotification('Error checking for updates', 'error');
			}
		}
		
		function clearAgentFilter() {
			document.getElementById('reportAgentName').value = '';
			document.getElementById('reportTable').style.display = 'none';
			document.getElementById('noResults').style.display = 'none';
			showNotification('Agent filter cleared', 'success');
		}

		function clearExpiryFilter() {
			document.getElementById('expiryFromDate').value = '';
			document.getElementById('expiryToDate').value = '';
			document.getElementById('reportTable').style.display = 'none';
			document.getElementById('noResults').style.display = 'none';
			showNotification('Expiry filter cleared', 'success');
		}

		function clearPendingFilter() {
			document.getElementById('pendingAmountFilter').value = '';
			document.getElementById('reportTable').style.display = 'none';
			document.getElementById('noResults').style.display = 'none';
			showNotification('Pending amount filter cleared', 'success');
		}

		function clearProfitFilter() {
			document.getElementById('profitFromDate').value = '';
			document.getElementById('profitToDate').value = '';
			document.getElementById('profitAgentFilter').value = '';
			document.getElementById('reportTable').style.display = 'none';
			document.getElementById('noResults').style.display = 'none';
			document.getElementById('profitSummary').style.display = 'none';
			showNotification('Profit filter cleared', 'success');
		}

		async function exportReport() {
			try {
				const table = document.getElementById('reportTable');
				if (table.style.display === 'none') {
					showNotification('No report data to export', 'warning');
					return;
				}
				
				showNotification('Exporting report...', 'warning');
				
				const rows = Array.from(table.querySelectorAll('tbody tr'));
				if (rows.length === 0) {
					showNotification('No report data to export', 'warning');
					return;
				}
				
				const headers = Array.from(table.querySelectorAll('thead th')).map(th => `"${th.textContent}"`);
				const csvData = rows.map(row => 
					Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent}"`)
				);
				
				const csvContent = [headers.join(','), ...csvData.map(row => row.join(','))].join('\n');
				
				const blob = new Blob([csvContent], { type: 'text/csv' });
				const url = window.URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `agreement_report_${new Date().toISOString().split('T')[0]}.csv`;
				a.click();
				window.URL.revokeObjectURL(url);
				
				showNotification('Report exported successfully!', 'success');
				
			} catch (error) {
				console.error('Report export error:', error);
				showNotification('Error exporting report', 'error');
			}
		}

        async function deleteAgreement(id) {
            if (!confirm('Are you sure you want to delete this agreement?')) {
                return;
            }

            try {
                const response = await apiCall(`/agreements/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Agreement deleted successfully!', 'success');
                    await loadAgreements();
                    logActivity('Deleted agreement', `ID: ${id}`);
                } else {
                    throw new Error('Failed to delete agreement');
                }
            } catch (error) {
                showNotification('Error deleting agreement', 'error');
            }
        }

        async function editAgreement(id) {
            try {
                const response = await apiCall(`/agreements/${id}`);
                const agreement = await response.json();
                openEditModal(agreement);
            } catch (error) {
                showNotification('Error loading agreement for editing', 'error');
            }
        }

        async function saveEditedAgreement() {
            const editData = collectEditFormData();
            
            if (!validateAgreementData(editData)) {
                return;
            }

            try {
                const response = await apiCall(`/agreements/${editData.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(editData)
                });

                if (response.ok) {
                    showNotification('Agreement updated successfully!', 'success');
                    closeEditModal();
                    await loadAgreements();
                    logActivity('Updated agreement', editData.ownerName);
                } else {
                    throw new Error('Failed to update agreement');
                }
            } catch (error) {
                showNotification('Error updating agreement', 'error');
            }
        }

        // Report functions
        async function generateReportByAgent() {
            const agentName = document.getElementById('reportAgentName').value;
            if (!agentName) {
                showNotification('Please select an agent', 'warning');
                return;
            }

            try {
                const response = await apiCall(`/reports/agent/${encodeURIComponent(agentName)}`);
                const data = await response.json();
                displayReportResults(data, `Report for Agent: ${agentName}`);
            } catch (error) {
                showNotification('Error generating report', 'error');
            }
        }

        async function generateExpiringReport() {
            const fromDate = document.getElementById('expiryFromDate').value;
            const toDate = document.getElementById('expiryToDate').value;

            if (!fromDate || !toDate) {
                showNotification('Please select both from and to dates', 'warning');
                return;
            }

            try {
                const response = await apiCall(`/reports/expiring?from=${fromDate}&to=${toDate}`);
                const data = await response.json();
                displayReportResults(data, `Expiring Agreements Report: ${fromDate} to ${toDate}`);
            } catch (error) {
                showNotification('Error generating report', 'error');
            }
        }

        async function generatePendingReport() {
            const filter = document.getElementById('pendingAmountFilter').value;
            if (!filter) {
                showNotification('Please select a filter condition', 'warning');
                return;
            }

            try {
                const response = await apiCall(`/reports/pending?filter=${filter}`);
                const data = await response.json();
                displayReportResults(data, `Pending Amount Report: ${filter === 'greater' ? 'Amount > 0' : 'Amount < 0'}`);
            } catch (error) {
                showNotification('Error generating report', 'error');
            }
        }

        // ===== CLOUD-BASED UTILITY FUNCTIONS =====

		// Tab management (can remain synchronous - no API calls)
		function showTab(tabName, element) {
			// Hide all tab contents
			document.querySelectorAll('.tab-content').forEach(tab => {
				tab.classList.remove('active');
			});
			
			// Remove active class from all tabs
			document.querySelectorAll('.tab').forEach(tab => {
				tab.classList.remove('active');
			});
			
			// Show selected tab content and set active tab
			document.getElementById(tabName).classList.add('active');
			element.classList.add('active');
			
			// Load tab-specific data if needed
			loadTabData(tabName);
		}

		// Async function to load tab-specific data
		async function loadTabData(tabName) {
			try {
				switch(tabName) {
					case 'agreements':
						await loadAgreements();
						break;
					case 'reports':
						// Pre-load agents list for reports
						await loadAgentsForReports();
						break;
					case 'logs':
						await loadActivityLogs();
						break;
					case 'settings':
						await loadSystemSettings();
						break;
				}
			} catch (error) {
				console.error(`Error loading ${tabName} data:`, error);
			}
		}

		// Notification function (can remain synchronous)
		function showNotification(message, type = 'success') {
			const notification = document.getElementById('notification');
			notification.textContent = message;
			notification.className = `notification ${type}`;
			notification.classList.add('show');
			
			setTimeout(() => {
				notification.classList.remove('show');
			}, 3000);
		}

		// Cloud-based profit calculation with error handling
		async function calculateProfit() {
			try {
				const totalPayment = parseFloat(document.getElementById('totalPayment').value) || 0;
				const actualCost = parseFloat(document.getElementById('actualCost').value) || 0;
				const agentCommission = parseFloat(document.getElementById('agentCommission').value) || 0;
				const otherExpenses = parseFloat(document.getElementById('otherExpenses').value) || 0;
				
				// Validate inputs
				if (totalPayment < 0 || actualCost < 0 || agentCommission < 0 || otherExpenses < 0) {
					showNotification('Please enter valid positive amounts', 'error');
					return;
				}
				
				// Gross Profit = Total Payment - Actual Cost
				const grossProfit = totalPayment - actualCost;
				
				// Net Profit = Gross Profit - Agent Commission - Other Expenses
				const netProfit = grossProfit - agentCommission - otherExpenses;
				
				// Profit Margin = (Net Profit / Total Payment) * 100
				const profitMargin = totalPayment > 0 ? (netProfit / totalPayment) * 100 : 0;
				
				// Update UI
				document.getElementById('grossProfit').value = grossProfit.toFixed(2);
				document.getElementById('netProfit').value = netProfit.toFixed(2);
				document.getElementById('profitMargin').value = profitMargin.toFixed(2);
				
			} catch (error) {
				console.error('Error calculating profit:', error);
				showNotification('Error calculating profit metrics', 'error');
			}
		}

		// Cloud-based due calculation
		async function calculateDue() {
			try {
				const total = parseFloat(document.getElementById('totalPayment').value) || 0;
				const owner = parseFloat(document.getElementById('paymentOwner').value) || 0;
				const tenant = parseFloat(document.getElementById('paymentTenant').value) || 0;
				
				if (total < 0 || owner < 0 || tenant < 0) {
					showNotification('Please enter valid positive amounts', 'error');
					return;
				}
				
				const due = total - owner - tenant;
				document.getElementById('paymentDue').value = due.toFixed(2);
				
				// Also calculate profit when payment fields change
				await calculateProfit();
				
			} catch (error) {
				console.error('Error calculating due amount:', error);
				showNotification('Error calculating payment due', 'error');
			}
		}

		

		// Enhanced validation for cloud application
		async function validateAgreementData(data) {
			try {
				// Required field validation
				if (!data.ownerName || !data.location || !data.tokenNumber) {
					showNotification('Please fill in all required fields (Owner Name, Location, Token Number)', 'error');
					return false;
				}
				
				// Token number uniqueness check (call to API)
				const tokenCheck = await checkTokenNumberUnique(data.tokenNumber, data.id);
				if (!tokenCheck.unique) {
					showNotification('Token number already exists. Please use a unique token number.', 'error');
					return false;
				}
				
				// Date validation
				if (data.agreementDate && data.expiryDate) {
					const agreementDate = new Date(data.agreementDate);
					const expiryDate = new Date(data.expiryDate);
					if (expiryDate <= agreementDate) {
						showNotification('Expiry date must be after agreement date', 'error');
						return false;
					}
				}
				
				// Financial validation
				if (data.totalPayment < 0 || data.paymentOwner < 0 || data.paymentTenant < 0) {
					showNotification('Payment amounts cannot be negative', 'error');
					return false;
				}
				
				return true;
			} catch (error) {
				console.error('Validation error:', error);
				showNotification('Error validating form data', 'error');
				return false;
			}
		}

		// Cloud function to check token number uniqueness
		async function checkTokenNumberUnique(tokenNumber, currentId = null) {
			try {
				const response = await apiCall(`/api/agreements/check-token?token=${encodeURIComponent(tokenNumber)}`);
				const result = await response.json();
				return result;
			} catch (error) {
				console.error('Error checking token uniqueness:', error);
				return { unique: true }; // Assume unique if check fails
			}
		}

		// Cloud-based form clearing
		async function clearForm() {
			try {
				document.querySelectorAll('#agreements input, #agreements select').forEach(element => {
					if (element.id !== 'ccEmail' && !element.readOnly) {
						element.value = '';
					}
				});
				
				// Reset profit fields
				document.getElementById('grossProfit').value = '';
				document.getElementById('netProfit').value = '';
				document.getElementById('profitMargin').value = '';
				
			} catch (error) {
				console.error('Error clearing form:', error);
			}
		}

		// Cloud-based agreement display
		async function displayAgreements(agreements) {
			try {
				const tbody = document.querySelector('#agreementsTable tbody');
				tbody.innerHTML = '';

				if (!agreements || agreements.length === 0) {
					tbody.innerHTML = `
						<tr>
							<td colspan="11" style="text-align: center; padding: 20px; color: #666;">
								No agreements found. Click "Add Agreement" to create your first agreement.
							</td>
						</tr>
					`;
					return;
				}

				agreements.forEach(agreement => {
					const row = document.createElement('tr');
					row.innerHTML = `
						<td>${escapeHtml(agreement.owner_name || '-')}</td>
						<td>${escapeHtml(agreement.location || '-')}</td>
						<td>${escapeHtml(agreement.token_number || '-')}</td>
						<td>${escapeHtml(agreement.owner_contact || '-')}</td>
						<td>${escapeHtml(agreement.tenant_contact || '-')}</td>
						<td>${escapeHtml(agreement.agent_name || '-')}</td>
						<td>${formatCurrency(agreement.total_payment || 0)}</td>
						<td>${formatCurrency(agreement.payment_due || 0)}</td>
						<td>${escapeHtml(agreement.agreement_status || '-')}</td>
						<td>${formatDate(agreement.expiry_date)}</td>
						<td>
							<button class="btn btn-warning" onclick="editAgreement(${agreement.id})" style="padding: 5px 10px; font-size: 12px;">Edit</button>
							<button class="btn btn-danger" onclick="deleteAgreement(${agreement.id})" style="padding: 5px 10px; font-size: 12px;">Delete</button>
						</td>
					`;
					tbody.appendChild(row);
				});
			} catch (error) {
				console.error('Error displaying agreements:', error);
				showNotification('Error loading agreements data', 'error');
			}
		}

		// Cloud-based activity logging
		async function logActivity(action, details) {
			try {
				const username = localStorage.getItem('currentUser') || 'system';
				
				// Send to server
				await apiCall('/api/activity-logs', {
					method: 'POST',
					body: JSON.stringify({
						username,
						action,
						details,
						ipAddress: await getClientIP()
					})
				});
				
				// Also update UI locally
				const logsContainer = document.getElementById('logsContainer');
				const logEntry = document.createElement('div');
				logEntry.innerHTML = `
					<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #3498db;">
						<strong>${new Date().toLocaleString()}</strong> - ${action}: ${details}
					</div>
				`;
				logsContainer.insertBefore(logEntry, logsContainer.firstChild);
				
			} catch (error) {
				console.error('Error logging activity:', error);
				// Fail silently - don't show error for logging failures
			}
		}

		// Helper function to get client IP (approximate)
		async function getClientIP() {
			try {
				const response = await fetch('https://api.ipify.org?format=json');
				const data = await response.json();
				return data.ip;
			} catch (error) {
				return 'unknown';
			}
		}

		// Security helper functions
		function escapeHtml(text) {
			if (!text) return '';
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function formatCurrency(amount) {
			const currencySymbol = '₹'; // Could be dynamic based on settings
			return `${currencySymbol}${parseFloat(amount).toFixed(2)}`;
		}

		function formatDate(dateString) {
			// If the date string is empty or invalid, return a placeholder
			if (!dateString) return '-';

			// Create a new Date object from the string
			const date = new Date(dateString);

			// Get day, month, and year
			// .getDate() returns 1-31
			// .getMonth() returns 0-11, so we add 1
			// .getFullYear() returns the 4-digit year
			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();

			// Combine them into the desired format
			return `${day}-${month}-${year}`;
		}
				
		// Cloud-based edit modal with API data fetching
		async function editAgreement(id) {
			try {
				showNotification('Loading agreement data...', 'warning');
				
				const response = await apiCall(`/api/agreements/${id}`);
				if (!response.ok) throw new Error('Failed to fetch agreement');
				
				const agreement = await response.json();
				await openEditModal(agreement);
				
			} catch (error) {
				console.error('Error loading agreement for editing:', error);
				showNotification('Error loading agreement data', 'error');
			}
		}

		async function openEditModal(agreement) {
			try {
				showNotification('Loading agreement data...', 'info');

				// Fetch required data like agent lists in parallel
				const [agentsResponse] = await Promise.all([
					apiCall('/agents') 
				]);
				
				if (!agentsResponse.ok) {
					throw new Error('Failed to load required data for editing.');
				}

				const agents = await agentsResponse.json();
				
				// Helper function to format dates for HTML date inputs (yyyy-mm-dd)
				const formatDateForInput = (dateString) => (dateString || '').slice(0, 10);
				
				const editFormGrid = document.getElementById('editFormGrid');

				// This now includes all fields from your main form
				editFormGrid.innerHTML = `
					<input type="hidden" id="editId" value="${agreement.id}">
					
					<div class="form-field">
						<label for="editOwnerName">Name of Owner</label>
						<input type="text" id="editOwnerName" value="${agreement.owner_name || ''}">
					</div>
					<div class="form-field">
						<label for="editLocation">Location</label>
						<input type="text" id="editLocation" value="${agreement.location || ''}">
					</div>
					<div class="form-field">
						<label for="editTokenNumber">Token Number</label>
						<input type="text" id="editTokenNumber" value="${agreement.token_number || ''}">
					</div>
					<div class="form-field">
						<label for="editAgreementDate">Agreement Date</label>
						<input type="date" id="editAgreementDate" value="${formatDateForInput(agreement.agreement_date)}">
					</div>
					<div class="form-field">
						<label for="editOwnerContact">Owner Contact</label>
						<input type="tel" id="editOwnerContact" value="${agreement.owner_contact || ''}">
					</div>
					<div class="form-field">
						<label for="editTenantContact">Tenant Contact</label>
						<input type="tel" id="editTenantContact" value="${agreement.tenant_contact || ''}">
					</div>
					<div class="form-field">
						<label for="editEmail">Email</label>
						<input type="email" id="editEmail" value="${agreement.email || ''}">
					</div>
					<div class="form-field">
						<label for="editExpiryDate">Expiry Date</label>
						<input type="date" id="editExpiryDate" value="${formatDateForInput(agreement.expiry_date)}">
					</div>
					<div class="form-field">
						<label for="editAgentName">Agent Name</label>
						<select id="editAgentName">
							<option value="">Select Agent</option>
							${agents.map(agent => 
								`<option value="${agent.name}" ${agreement.agent_name === agent.name ? 'selected' : ''}>
									${agent.name}
								</option>`
							).join('')}
						</select>
					</div>
					<div class="form-field">
						<label for="editTotalPayment">Total Payment</label>
						<input type="number" id="editTotalPayment" step="0.01" value="${agreement.total_payment || 0}" onchange="calculateEditDue()">
					</div>
					<div class="form-field">
						<label for="editPaymentOwner">Pymnt Rcvd from Owner</label>
						<input type="number" id="editPaymentOwner" step="0.01" value="${agreement.payment_owner || 0}" onchange="calculateEditDue()">
					</div>
					<div class="form-field">
						<label for="editPaymentTenant">Pymnt Rcvd from Tenant</label>
						<input type="number" id="editPaymentTenant" step="0.01" value="${agreement.payment_tenant || 0}" onchange="calculateEditDue()">
					</div>
					<div class="form-field">
						<label for="editPaymentDue">Payment Due</label>
						<input type="number" id="editPaymentDue" step="0.01" value="${agreement.payment_due || 0}" readonly>
					</div>
					<div class="form-field">
						<label for="editAgreementStatus">Agreement Status</label>
						<select id="editAgreementStatus">
							 <option value="Drafted" ${agreement.agreement_status === 'Drafted' ? 'selected' : ''}>Drafted</option>
							<option value="Sent to Client" ${agreement.agreement_status === 'Sent to Client' ? 'selected' : ''}>Sent to Client</option>
							<option value="Biometric Scheduled" ${agreement.agreement_status === 'Biometric Scheduled' ? 'selected' : ''}>Biometric Scheduled</option>
							<option value="Biometrics Completed" ${agreement.agreement_status === 'Biometrics Completed' ? 'selected' : ''}>Biometrics Completed</option>
							<option value="Send Final Draft to Client" ${agreement.agreement_status === 'Send Final Draft to Client' ? 'selected' : ''}>Send Final Draft to Client</option>
							<option value="Submitted" ${agreement.agreement_status === 'Submitted' ? 'selected' : ''}>Submitted</option>
							<option value="Registered" ${agreement.agreement_status === 'Registered' ? 'selected' : ''}>Registered</option>
							<option value="Registered agreement sent to the client" ${agreement.agreement_status === 'Registered agreement sent to the client' ? 'selected' : ''}>Registered agreement sent to the client</option>
						</select>
					</div>
				`;
				
				document.getElementById('editModal').style.display = 'block';
				
			} catch (error) {
				console.error('Error opening edit modal:', error);
				showNotification('Error loading agreement data. Please try again.', 'error');
			}
		}
		
		function calculateEditDue() {
			const total = parseFloat(document.getElementById('editTotalPayment').value) || 0;
			const owner = parseFloat(document.getElementById('editPaymentOwner').value) || 0;
			const tenant = parseFloat(document.getElementById('editPaymentTenant').value) || 0;
			const due = total - owner - tenant;
			document.getElementById('editPaymentDue').value = due.toFixed(2);
		}

		/**
		 * Collects all data from the edit modal form to send to the server.
		 */
		function collectEditFormData() {
			// Use snake_case to send data
			return {
				id: document.getElementById('editId').value,
				owner_name: document.getElementById('editOwnerName').value,
				location: document.getElementById('editLocation').value,
				token_number: document.getElementById('editTokenNumber').value,
				agreement_date: document.getElementById('editAgreementDate').value,
				owner_contact: document.getElementById('editOwnerContact').value,
				tenant_contact: document.getElementById('editTenantContact').value,
				email: document.getElementById('editEmail').value,
				expiry_date: document.getElementById('editExpiryDate').value,
				reminder_date: document.getElementById('editReminderDate').value,
				agent_name: document.getElementById('editAgentName').value,
				total_payment: parseFloat(document.getElementById('editTotalPayment').value) || 0,
				payment_owner: parseFloat(document.getElementById('editPaymentOwner').value) || 0,
				payment_tenant: parseFloat(document.getElementById('editPaymentTenant').value) || 0,
				payment_received_date1: document.getElementById('editPaymentReceivedDate1').value,
				payment_received_date2: document.getElementById('editPaymentReceivedDate2').value,
				payment_due: parseFloat(document.getElementById('editPaymentDue').value) || 0,
				agreement_status: document.getElementById('editAgreementStatus').value,
				biometric_date: document.getElementById('editBiometricDate').value
			};
		}
		
		// Cloud-based report display with API data
		async function displayReportResults(data, title) {
			try {
				const table = document.getElementById('reportTable');
				const tbody = table.querySelector('tbody');
				const noResults = document.getElementById('noResults');
				
				tbody.innerHTML = '';
				
				if (!data || data.length === 0) {
					table.style.display = 'none';
					noResults.style.display = 'block';
					showNotification('No results found for the selected criteria', 'warning');
					return;
				}
				
				// Process data with error handling
				data.forEach(item => {
					try {
						const row = document.createElement('tr');
						row.innerHTML = `
							<td>${escapeHtml(item.owner_name || '-')}</td>
							<td>${escapeHtml(item.token_number || '-')}</td>
							<td>${escapeHtml(item.location || '-')}</td>
							<td>${formatCurrency(item.total_payment || 0)}</td>
							<td>${formatCurrency(item.payment_due || 0)}</td>
							<td>${escapeHtml(item.agent_name || '-')}</td>
							<td>${formatCurrency(item.net_profit || 0)}</td>
							<td>${item.profit_margin ? item.profit_margin.toFixed(2) + '%' : '-'}</td>
						`;
						tbody.appendChild(row);
					} catch (rowError) {
						console.error('Error creating table row:', rowError);
					}
				});
				
				table.style.display = 'table';
				noResults.style.display = 'none';
				
				// Generate summary statistics
				await generateReportSummary(data, title);
				
			} catch (error) {
				console.error('Error displaying report results:', error);
				showNotification('Error displaying report data', 'error');
			}
		}

		// Helper function for currency formatting
		function formatCurrency(amount) {
			const currencySymbol = document.getElementById('currencySymbol')?.value || '₹';
			return `${currencySymbol}${parseFloat(amount).toFixed(2)}`;
		}

		// Helper function for HTML escaping
		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
		
		// Add these missing functions
		async function loadAgentsForReports() {
			try {
				const response = await apiCall('/agents');
				const agents = await response.json();
				// Populate agent dropdowns
				const agentSelects = document.querySelectorAll('#reportAgentName, #profitAgentFilter');
				agentSelects.forEach(select => {
					select.innerHTML = '<option value="">Select Agent</option>' + 
						agents.map(agent => `<option value="${agent.name}">${agent.name}</option>`).join('');
				});
			} catch (error) {
				console.error('Error loading agents:', error);
			}
		}

		async function loadActivityLogs() {
			try {
				const response = await apiCall('/activity-logs?limit=50');
				const logs = await response.json();
				const container = document.getElementById('logsContainer');
				
				if (logs.length === 0) {
					container.innerHTML = '<p>No activity logs found.</p>';
					return;
				}
				
				container.innerHTML = logs.map(log => `
					<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #3498db;">
						<strong>${new Date(log.created_at).toLocaleString()}</strong> - 
						<strong>${log.username}</strong>: ${log.action} - ${log.details}
					</div>
				`).join('');
			} catch (error) {
				console.error('Error loading logs:', error);
				document.getElementById('logsContainer').innerHTML = '<p>Error loading activity logs.</p>';
			}
		}

		async function loadSystemSettings() {
			try {
				const response = await apiCall('/settings');
				const settings = await response.json();
				
				// Apply settings to form fields if they exist
				if (settings.default_cc_email) {
					document.getElementById('defaultCCEmail').value = settings.default_cc_email;
					document.getElementById('ccEmail').value = settings.default_cc_email;
				}
				if (settings.company_name) document.getElementById('companyName').value = settings.company_name;
				if (settings.reminder_days_before) document.getElementById('reminderDaysBefore').value = settings.reminder_days_before;
				if (settings.date_format) document.getElementById('dateFormat').value = settings.date_format;
				if (settings.currency_symbol) document.getElementById('currencySymbol').value = settings.currency_symbol;
				if (settings.session_timeout) document.getElementById('sessionTimeout').value = settings.session_timeout;
				if (settings.max_records_per_page) document.getElementById('maxRecordsPerPage').value = settings.max_records_per_page;
				
			} catch (error) {
				console.error('Error loading settings:', error);
			}
		}

		// REPLACE your current collectAgreementData function
		async function validateAgreementData(data) {
			try {
				// Required field validation
				if (!data.ownerName || !data.location || !data.tokenNumber) {
					showNotification('Please fill in all required fields (Owner Name, Location, Token Number)', 'error');
					return false;
				}
				
				// Token number uniqueness check (call to API)
				const tokenCheck = await checkTokenNumberUnique(data.tokenNumber, data.id);
				if (!tokenCheck.unique) {
					showNotification('Token number already exists. Please use a unique token number.', 'error');
					return false;
				}
				
				// Date validation
				if (data.agreementDate && data.expiryDate) {
					const agreementDate = new Date(data.agreementDate);
					const expiryDate = new Date(data.expiryDate);
					if (expiryDate <= agreementDate) {
						showNotification('Expiry date must be after agreement date', 'error');
						return false;
					}
				}
				
				// Financial validation
				if (data.totalPayment < 0 || data.paymentOwner < 0 || data.paymentTenant < 0) {
					showNotification('Payment amounts cannot be negative', 'error');
					return false;
				}
				
				return true;
			} catch (error) {
				console.error('Validation error:', error);
				showNotification('Error validating form data', 'error');
				return false;
			}
		}
		// Generate report summary statistics
		async function generateReportSummary(data, title) {
			try {
				const totalRevenue = data.reduce((sum, item) => sum + (item.total_payment || 0), 0);
				const totalProfit = data.reduce((sum, item) => sum + (item.net_profit || 0), 0);
				const avgMargin = data.length > 0 ? (totalProfit / totalRevenue) * 100 : 0;
				
				// Update summary cards
				document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
				document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
				document.getElementById('averageMargin').textContent = avgMargin.toFixed(2) + '%';
				
				// Show profit summary section
				document.getElementById('profitSummary').style.display = 'grid';
				
				showNotification(`${title} generated successfully! ${data.length} records found.`, 'success');
				
			} catch (error) {
				console.error('Error generating report summary:', error);
			}
		}

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            document.getElementById('buildDate').textContent = new Date().toISOString().split('T')[0];
        });
    </script>
</body>
</html>